---
title: "flat_export_excel.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
library(openxlsx)
library(assertthat)
library(comprehenr)
library(collections)
library(stringr)
library(reader)
library(feather)
library(readODS)
```

# Fonctions d'édition d'un classeur Excel

Ces fonctions agissent sur des objets de type `workbook` (du package openxlsx), en ajoutant des données, des titres, des sources...

## Creer une liste de style Excel

```{r function_creer_liste_style_excel}

#' Parametrer le tableur excel
#' 
#' Cette fonction permet de créer une liste avec tous les styles utiles aux publications Agreste xlsx
#' @param format le format choisi : "chiffres_et_donnees" ou "primeur"
#'
#' @return une liste avec tous les styles disponibles (objets openxls)
#' @export
#' 
#' @importFrom openxlsx createStyle
#' @importFrom assertthat assert_that
#' 
#' @examples
creer_liste_style_excel <- function(format = "chiffres_et_donnees") {
  assert_that((format %in% c("chiffres_et_donnees", "primeur")), msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  
  options("openxlsx.borderStyle" = "thin")
  options("openxlsx.borderColour" = "black")
  options("openxlsx.dateFormat" = "mm/dd/yyyy")
  options("openxlsx.paperSize" = 9)
  options("openxlsx.orientation" = "portrait")
  
  if (format == "chiffres_et_donnees") {
    font <- "Marianne"
  } else if (format == "primeur") {
    font <- "Calibri"
  }
  
  titleStyle <- createStyle(
    fontName = font,
    fontSize = 11,
    fontColour = "black",
    halign = "left",
    valign = "center",
    textDecoration = "bold",
    wrapText = TRUE
  )
  
  liste_style <- list(titre = titleStyle)
  
  titre_primeur_style <- createStyle(
    fontName = font,
    fontSize = 14,
    fontColour = "#548235",
    halign = "left",
    valign = "center",
    textDecoration = "bold",
    wrapText = TRUE
  )
  
  liste_style <-
    append(liste_style, values = c(titre_primeur = titre_primeur_style))
  
  subtitleStyle <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "right",
    valign = "center",
    textDecoration = "italic",
    wrapText = TRUE
  )
  
  liste_style <-
    append(liste_style, values = c(sous_titre = subtitleStyle))
  
  headerStyle <- switch(
    format,
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "center",
      valign = "center",
      fgFill = "#FF8D7E",
      border = "TopBottomLeftRight",
      borderColour = "black",
      textDecoration = "bold",
      wrapText = TRUE
    ),
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "white",
      halign = "center",
      valign = "center",
      fgFill = "#548235",
      border = "TopBottomLeftRight",
      borderColour = "black",
      textDecoration = "bold",
      wrapText = TRUE
    )
  )
  
  
  liste_style <-
    append(liste_style, values = c(ligne_titre = headerStyle))

  
  unitsUnifStyle <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "right",
    valign = "center",
    textDecoration = "italic",
    wrapText = TRUE,
    indent = 1
  )
  
  liste_style <-
    append(liste_style, values = c(lignes_unite_uniforme = unitsUnifStyle))
  
  unitsDiffStyle <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "right",
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    textDecoration = "italic",
    wrapText = TRUE,
    indent = 1
  )
  
  liste_style <-
    append(liste_style, values = c(lignes_unites_differentes = unitsDiffStyle))
  
  dataStyleText <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "left",
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    wrapText = TRUE
  )
  
  liste_style <-
    append(liste_style, values = c(texte = dataStyleText))
  
  
  dataStyleNum <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "right",
    indent = 1,
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    wrapText = TRUE,
    numFmt = "#,##0"
  )
  
  liste_style <-
    append(liste_style, values = c(numerique = dataStyleNum))
  
  dataStyleNumDecimal <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "right",
    indent = 1,
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    wrapText = TRUE,
    numFmt = "#,##0.00"
  )
  
  liste_style <-
    append(liste_style, values = c(decimal = dataStyleNumDecimal))
  
  
  dataItalicStyleText <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "left",
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    wrapText = TRUE,
    textDecoration = "italic"
  )
  
  liste_style <-
    append(liste_style, values = c(texte_italique = dataItalicStyleText))
  
  
  dataItalicStyleNum <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "right",
    indent = 1,
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    wrapText = TRUE,
    numFmt = "#,##0",
    textDecoration = "italic"
  )
  
  liste_style <-
    append(liste_style,
           values = c(numerique_italique = dataItalicStyleNum))
  
  
  dataItalicStyleDecimal <-createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "right",
    indent = 1,
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    wrapText = TRUE,
    numFmt = "#,##0.00",
    textDecoration = "italic"
  )
  
  liste_style <-
    append(liste_style,
           values = c(decimal_italique = dataItalicStyleDecimal))
  
  
  dataTotalStyleText <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "left",
      valign = "center",
      fgFill = "#d9d9d9",
      textDecoration = "bold",
      wrapText = TRUE
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "left",
      valign = "center",
      fgFill = "#ff8d7e",
      textDecoration = "bold",
      wrapText = TRUE
    )
  )
    
  
  liste_style <-
    append(liste_style, values = c(texte_total = dataTotalStyleText))
  
  
  dataTotalStyleNum <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      fgFill = "#d9d9d9",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0",
      indent = 1
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      fgFill = "#ff8d7e",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0",
      indent = 1
    )
  )
    
  
  liste_style <-
    append(liste_style, values = c(numerique_total = dataTotalStyleNum))
  
  
  dataTotalStyleNumDecimal <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      fgFill = "#d9d9d9",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0.00",
      indent = 1
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      fgFill = "#ff8d7e",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0.00",
      indent = 1
    )
  )
  
  liste_style <-
    append(liste_style,
           values = c(decimal_total = dataTotalStyleNumDecimal))
  
  
  dataSubTotalStyleText <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "left",
      valign = "center",
      textDecoration = "bold",
      wrapText = TRUE
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "left",
      valign = "center",
      textDecoration = "bold",
      wrapText = TRUE
    )
  )
  
  liste_style <-
    append(liste_style,
           values = c(texte_sous_total = dataSubTotalStyleText))
  
  
  
  dataSubTotalStyleNum <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0",
      indent = 1
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0",
      indent = 1
    )
  )
  
  liste_style <-
    append(liste_style,
           values = c(numerique_sous_total = dataSubTotalStyleNum))
  
  
  dataSubTotalStyleNumDecimal <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0.00",
      indent = 1
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "right",
      valign = "center",
      textDecoration = "bold",
      wrapText = TRUE,
      numFmt = "#,##0.00",
      indent = 1
    )
  )
  
  liste_style <-
    append(liste_style,
           values = c(decimal_sous_total = dataSubTotalStyleNumDecimal))
  
  
  dataPrecisionStyleText1 <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "left",
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    indent = 1,
    wrapText = TRUE
  )
    
  liste_style <-
    append(liste_style,
           values = c(precision_texte_1 = dataPrecisionStyleText1))
  
  dataPrecisionStyleText2 <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "left",
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    indent = 2,
    wrapText = TRUE
  )
    
  liste_style <-
    append(liste_style,
           values = c(precision_texte_2 = dataPrecisionStyleText2))
    
  dataPrecisionStyleText3 <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "left",
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    indent = 3,
    wrapText = TRUE
  )
    
  liste_style <-
    append(liste_style,
           values = c(precision_texte_3 = dataPrecisionStyleText3))
  
  dataPrecisionStyleText4 <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    halign = "left",
    valign = "center",
    border = "LeftRight",
    borderColour = "black",
    indent = 4,
    wrapText = TRUE
  )
    
  liste_style <-
    append(liste_style,
           values = c(precision_texte_4 = dataPrecisionStyleText4))
  
  dataSectionStyleText <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "left",
      valign = "center",
      border = "TopBottom",
      borderColour = "black",
      fgFill = "#c6ddb4",
      textDecoration = "bold",
      wrapText = TRUE
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      halign = "center",
      valign = "center",
      border = "TopBottom",
      borderColour = "black",
      textDecoration = "bold",
      wrapText = TRUE
    )
  )
  
  
  liste_style <-
    append(liste_style, values = c(texte_section = dataSectionStyleText))
  
  
  noteStyle <- createStyle(
    fontName = font,
    fontSize = 9,
    fontColour = "black",
    borderColour = "black",
    textDecoration = "italic",
    valign = "center",
    wrapText = TRUE
  )
  
  liste_style <- append(liste_style, values = c(note = noteStyle))
  
  sourceStyle <- createStyle(
    fontName = font,
    fontSize = 9,
    fontColour = "black",
    textDecoration = "italic",
    valign = "center",
    wrapText = TRUE
  )
  
  liste_style <-
    append(liste_style, values = c(source = sourceStyle))
  
  
  champStyle <- createStyle(
    fontName = font,
    fontSize = 9,
    fontColour = "black",
    textDecoration = "italic",
    valign = "center",
    wrapText = TRUE
  )
  
  liste_style <-
    append(liste_style, values = c(champ = champStyle))
  
  sommaireChapitreStyle <- switch(format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 11,
      fontColour = "white",
      halign = "left",
      valign = "center",
      fgFill = "#548235",
      borderColour = "black",
      textDecoration = "bold",
      wrapText = TRUE
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 11,
      fontColour = "black",
      halign = "left",
      valign = "center",
      fgFill = "#FF8D7E",
      borderColour = "black",
      textDecoration = "bold",
      wrapText = TRUE
    )
  )
  
  
  liste_style <-
    append(liste_style,
           values = c(sommaire_chapitre = sommaireChapitreStyle))
  
  sommaireSousChapitreStyle <- switch (format,
    "primeur" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      indent = 1,
      halign = "left",
      valign = "center",
      fgFill = "#d9d9d9",
      borderColour = "black",
      textDecoration = "bold",
      wrapText = TRUE
    ),
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 10,
      fontColour = "black",
      indent = 1,
      halign = "left",
      valign = "center",
      fgFill = "#FFE2DB",
      borderColour = "black",
      textDecoration = "bold",
      wrapText = TRUE
    )
  )
    
    createStyle(
    
  )

  liste_style <-
    append(liste_style,
           values = c(sommaire_sous_chapitre = sommaireSousChapitreStyle))
  
  
  sommaireSheetStyle <- createStyle(
    fontName = font,
    fontSize = 10,
    fontColour = "black",
    indent = 3,
    halign = "left",
    valign = "center",
    wrapText = TRUE
  )
  
  liste_style <-
    append(liste_style, values = c(sommaire_lien = sommaireSheetStyle))
  
  
  retourSommaireSheetStyle <- switch (format,
    "chiffres_et_donnees" = createStyle(
      fontName = font,
      fontSize = 11,
      fontColour = "black",
      halign = "center",
      valign = "center",
      fgFill = "#FF8D7E",
      wrapText = TRUE
    ),
    "primeur" = createStyle(
      fontName = font,
      fontSize = 11,
      fontColour = "white",
      halign = "center",
      valign = "center",
      fgFill = "#548235",
      wrapText = TRUE
    )
  )
    
    
    
  liste_style <-
    append(liste_style,
           values = c(bouton_retour_sommaire = retourSommaireSheetStyle))
  
  return(liste_style)
  
}

```

```{r examples_creer_liste_style_excel, eval=FALSE}
library(agreste)
mes_styles <- creer_liste_style_excel(format = "chiffres_et_donnees")

#exemples
mes_styles$ligne_titre
mes_styles$numerique

```


```{r tests_creer_liste_style_excel}
test_that("L'objet retourné est une liste", {
  expect_true(class(creer_liste_style_excel()) == "list")
})
test_that('Les styles définis sont bien de type "Style"', {
  mes_styles <- creer_liste_style_excel()
  for (st in mes_styles) {
    expect_true(class(st) == "Style")
  }
})
```

```{r function-row_to_add_format}
#' Renvoie le nombre de lignes à ajouter selon le format
#' 
#' @param format CHAR le format choisi entre "chiffres_et_donnees" et "primeur"
#' 
#' @return NUM le nombre de lignes à ajouter
row_to_add_format <- function(format) {
  if (format == "chiffres_et_donnees") {
    return(0)
  } else {
    return(2)
  }
}
```

## Ajouter un tableau Excel

```{r function_ajouter_tableau_excel}
#' Ajouter un tableau dans une feuille excel
#'
#' Cette fonction crée une nouvelle feuille dans le classeur passé en paramètre et y insère un tableau mis en forme.
#'
#' @param classeur workbook créé avec openXLSX
#' @param tableau dataframe ou tibble à insérer dans une nouvelle feuille
#' @param nom_feuille nom de la nouvelle feuille
#' @param ligne_debut la ligne à laquelle démarre le tableau
#' @param col_debut la colonne à laquelle démarre le tableau
#' 
#' @return Rien n'est renvoyé mais l'objet classeur a une nouvelle feuille
#' 
#' @importFrom openxlsx addWorksheet
#' @importFrom openxlsx writeData
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' 
#' @export
#'
#' @examples
ajouter_tableau_excel <- function(classeur, tableau, nom_feuille, ligne_debut = 3, col_debut = 2) {

  assert_that(class(classeur)=="Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(is.data.frame(tableau),
              msg = "Le tableau doit \u00eatre un dataframe ou un tibble.")
  assert_that(is.string(nom_feuille),
              msg = "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(ligne_debut > 0,
              msg = "La ligne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(is.numeric(ligne_debut),
              msg = "La ligne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  
  addWorksheet(wb = classeur,
               sheetName = nom_feuille)
  writeData(wb = classeur,
            sheet = nom_feuille,
            x = tableau,
            startCol = col_debut,
            startRow = ligne_debut)
}
```

```{r examples_ajouter_tableau_excel, eval=FALSE}

# Création d'un classeur avec une feuille contenant iris et une feuille contenant airquality
# Sauvegarde du classeur
# Ouverture du classeur
library(openxlsx)
library(agreste)
mon_classeur <- createWorkbook()

mes_styles <- creer_liste_style_excel()

start_ligne = 3
start_col = 2
nb_col = ncol(iris)

ajouter_tableau_excel(classeur = mon_classeur, tableau = iris, nom_feuille = "iris")
addStyle(wb = mon_classeur, sheet = "iris", style = mes_styles$ligne_titre, rows = start_ligne, cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur, sheet = "iris", style = mes_styles$decimal, rows = (start_ligne+1):(nrow(iris)+start_ligne), cols = 2)
addStyle(wb = mon_classeur, sheet = "iris", style = mes_styles$decimal, rows = (start_ligne+1):(nrow(iris)+start_ligne), cols = 3)
addStyle(wb = mon_classeur, sheet = "iris", style = mes_styles$decimal, rows = (start_ligne+1):(nrow(iris)+start_ligne), cols = 4)
addStyle(wb = mon_classeur, sheet = "iris", style = mes_styles$decimal_italique, rows = (start_ligne+1):(nrow(iris)+start_ligne), cols = 5)
addStyle(wb = mon_classeur, sheet = "iris", style = mes_styles$texte, rows = (start_ligne+1):(nrow(iris)+start_ligne), cols = 6)

start_ligne = 3
start_col = 2
nb_col = ncol(airquality)

ajouter_tableau_excel(classeur = mon_classeur, tableau = airquality, nom_feuille = "airquality")
addStyle(wb = mon_classeur, sheet = "airquality", style = mes_styles$ligne_titre, rows = start_ligne, cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur, sheet = "airquality", style = mes_styles$numerique, rows = (start_ligne+1):(nrow(airquality)+start_ligne), cols = 2)
addStyle(wb = mon_classeur, sheet = "airquality", style = mes_styles$numerique, rows = (start_ligne+1):(nrow(airquality)+start_ligne), cols = 3)
addStyle(wb = mon_classeur, sheet = "airquality", style = mes_styles$decimal, rows = (start_ligne+1):(nrow(airquality)+start_ligne), cols = 4)
addStyle(wb = mon_classeur, sheet = "airquality", style = mes_styles$numerique, rows = (start_ligne+1):(nrow(airquality)+start_ligne), cols = 5)
addStyle(wb = mon_classeur, sheet = "airquality", style = mes_styles$numerique, rows = (start_ligne+1):(nrow(airquality)+start_ligne), cols = 6)
addStyle(wb = mon_classeur, sheet = "airquality", style = mes_styles$numerique, rows = (start_ligne+1):(nrow(airquality)+start_ligne), cols = 7)

saveWorkbook(wb = mon_classeur, file = "tableau.xlsx", overwrite = TRUE)

browseURL("tableau.xlsx")

```


```{r tests_ajouter_tableau_excel}
test_that("mon_classeur fonctionne correctement et renvoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()

  expect_error(ajouter_tableau_excel(classeur = "iris",
                                     tableau = iris,
                                     nom_feuille = "tab_iris"),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(ajouter_tableau_excel(classeur = mon_classeur,
                                     tableau = "tab_iris",
                                     nom_feuille = "tab_iris"),
               "Le tableau doit \u00eatre un dataframe ou un tibble.")
  expect_error(ajouter_tableau_excel(classeur = mon_classeur,
                                     tableau = iris,
                                     nom_feuille = iris),
               "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_tableau_excel(classeur = mon_classeur,
                                     tableau = iris,
                                     nom_feuille = "tab_iris",
                                     ligne_debut = 0,
                                     col_debut = 2),
               "La ligne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_tableau_excel(classeur = mon_classeur,
                                     tableau = iris,
                                     nom_feuille = "tab_iris",
                                     ligne_debut = 3,
                                     col_debut = 0),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_tableau_excel(classeur = mon_classeur,
                                     tableau = iris,
                                     nom_feuille = "tab_iris",
                                     ligne_debut = "1",
                                     col_debut = 2),
               "La ligne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_tableau_excel(classeur = mon_classeur,
                                     tableau = iris,
                                     nom_feuille = "tab_iris",
                                     ligne_debut = 3,
                                     col_debut = "2"),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")

})

test_that("Le tableau ajouté est le même dans le workbook", {
  mon_classeur <- openxlsx::createWorkbook()
  
  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = iris,
                        nom_feuille = "Iris")
  
  expect_equal(sum(openxlsx::readWorkbook(mon_classeur, colNames = TRUE) == iris), 750)
})

test_that("Les noms de feuille sont les bons", {
  mon_classeur <- openxlsx::createWorkbook()
  for (i in 1:6) {
    ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = iris,
                        nom_feuille = paste("Iris", i))
  }
  expect_true(sum(names(mon_classeur) == c("Iris 1", "Iris 2", "Iris 3", "Iris 4", "Iris 5", "Iris 6")) == 6)
  
})

```

## Ajouter un titre à un primeur

```{r function-ajouter_titre_primeur}
#' Ajouter le titre du primeur dans la première cellule de chaque feuille
#'
#' Cette fonction permet d'ajouter le titre en haut de chaque feuille 
#' d'un classeur de type primeur
#'
#' @param classeur workbook créé avec openXLSX
#' @param titre le titre à ajouter
#' @param col_debut la colonne de départ (2eme par défaut)
#' @param fusion LGL si les cellules sont à fusionner ou pas (TRUE par défaut)
#'
#' @return Rien n'est renvoyé mais la feuille du classeur est modifiée
#' 
#' @importFrom openxlsx writeData
#' @importFrom openxlsx addStyle
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx mergeCells
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' 
#' @export
#'
#' @examples
ajouter_titre_primeur <- function(classeur,
                                  titre,
                                  col_debut = 2,
                                  fusion = TRUE) {
  
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(is.string(titre),
              msg = "Le titre doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(class(fusion) == "logical",
              msg = "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  
  liste_style = creer_liste_style_excel(format = "primeur")
  style_titre_primeur = liste_style$titre_primeur
  
  write_row <- 1 
  
  for (feuille in names(classeur)) {
    if (isTRUE(fusion)) {
      nb_col = ncol(readWorkbook(classeur, sheet = feuille))
      if (!is.null(nb_col)) {
        mergeCells(classeur, feuille, cols = col_debut:(col_debut+nb_col-1), rows = write_row)
      }
    }
    writeData(classeur, feuille, titre, startCol = col_debut, startRow = write_row)
    addStyle(wb = classeur, sheet = feuille, style = style_titre_primeur, rows = write_row, cols = col_debut)
  }
  
  
}
```

```{r examples-ajouter_titre_primeur, eval=FALSE}
library(openxlsx)
library(agreste)
mon_classeur <- createWorkbook()

mes_styles <- creer_liste_style_excel(format = "primeur")

start_ligne = 5
start_col = 2
nb_col = ncol(iris)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris",
                      ligne_debut = 5)

## Formatage

addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal_italique,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 5)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$texte,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 6)

## Ajout du titre 

ajouter_titre_primeur(classeur = mon_classeur,
                      titre = "Iris")

## Sauvegarde
saveWorkbook(wb = mon_classeur,
             file = "tableau.xlsx",
             overwrite = TRUE)

browseURL("tableau.xlsx")
```


```{r tests_ajouter_titre_primeur}
test_that("ajouter_titre_primeur fonctionne correctement et renvoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()
  nom_page <- "nom_onglet"
  openxlsx::addWorksheet(mon_classeur, "iris")
  titre = "Données iris"
  
  expect_error(ajouter_titre_primeur(classeur = nom_page,
                                     titre = titre),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(ajouter_titre_primeur(classeur = mon_classeur,
                                     titre = iris),
               "Le titre doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_titre_primeur(classeur = mon_classeur,
                                     titre = titre,
                                     col_debut = "2"),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_titre_primeur(classeur = mon_classeur,
                                     titre = titre,
                                     col_debut = 0),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_titre_primeur(classeur = mon_classeur,
                                     titre = titre,
                                     col_debut = 2,
                                     fusion = "oui"),
               "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")

})

test_that("Le titre est le bon dans le workbook", {
  mon_classeur <- openxlsx::createWorkbook()
  titre = "Données iris"
  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = iris, 
                        nom_feuille = "iris",
                        col_debut = 5)
  ajouter_titre_primeur(classeur = mon_classeur,
                        titre = titre)
  expect_true(openxlsx::readWorkbook(mon_classeur, colNames = FALSE, skipEmptyRows = FALSE)$X1[1] == titre)
})

```

## Ajouter le titre d'un tableau

```{r function_ajouter_titre_tableau}
#' Ajouter le titre du tableau dans la première cellule d'une feuille
#'
#' Cette fonction permet d'ajouter un titre dans la cellule A1 d'une feuille
#'
#' @param classeur workbook créé avec openXLSX
#' @param nom_feuille nom de la feuille
#' @param titre le titre à ajouter
#' @param col_debut la colonne de départ (2eme par défaut)
#' @param format CHAR le type de publication : "chiffres_et_donnees" ou "primeur" 
#' @param fusion LGL si les cellules sont à fusionner ou pas (TRUE par défaut)
#'
#' @return Rien n'est renvoyé mais la feuille du classeur est modifiée
#' 
#' @importFrom openxlsx writeData
#' @importFrom openxlsx addStyle
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx mergeCells
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' 
#' @export
#'
#' @examples
ajouter_titre_tableau <- function(classeur,
                                  nom_feuille,
                                  titre,
                                  col_debut = 2,
                                  format = "chiffres_et_donnees",
                                  fusion = TRUE) {
  
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(is.string(nom_feuille),
              msg = "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(is.string(titre),
              msg = "Le titre doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(class(format)=="character",
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(format %in% c("chiffres_et_donnees", "primeur"),
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(class(fusion) == "logical",
              msg = "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  
  liste_style = creer_liste_style_excel(format = format)
  style_titre = liste_style$titre
  
  nb_col = ncol(readWorkbook(classeur, sheet = nom_feuille))
  
  write_row <- 1 + row_to_add_format(format = format)
  
  if (isTRUE(fusion)) {
    if (!is.null(nb_col)) {
      mergeCells(classeur, nom_feuille, cols = col_debut:(col_debut+nb_col-1), rows = write_row )
    }
  }
  writeData(classeur, nom_feuille, titre, startCol = col_debut, startRow = write_row)
  addStyle(wb = classeur, sheet = nom_feuille, style = style_titre, rows = write_row, cols = col_debut)
  setRowHeights(wb = classeur,
                sheet = nom_feuille,
                rows = write_row,
                heights = (1 + nchar(titre)%/%100)*15)
}

```

```{r examples_ajouter_titre_tableau, eval=FALSE}

library(openxlsx)
library(agreste)

## Création d'un classeur

mon_classeur <- createWorkbook()

mes_styles <- creer_liste_style_excel(format = "chiffres_et_donnees")

start_ligne = 3
start_col = 2
nb_col = ncol(iris)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris")

## Formatage

addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal_italique,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 5)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$texte,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 6)

## Ajout du titre 

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "iris",
                      titre = "Données fleurs iris",
                      col_debut = 2,
                      format = "chiffres_et_donnees")

## Deuxième feuille

start_ligne = 3
start_col = 2
nb_col = ncol(airquality)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = airquality,
                      nom_feuille = "airquality")

addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 5)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 6)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 7)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "airquality",
                      titre = "Données qualité de l'air",
                      col_debut = 2)

saveWorkbook(wb = mon_classeur,
             file = "tableau.xlsx",
             overwrite = TRUE)

browseURL("tableau.xlsx")

```


```{r tests_ajouter_titre_tableau}
test_that("mon_classeur fonctionne correctement et renvoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()
  nom_page <- "nom_onglet"
  openxlsx::addWorksheet(mon_classeur, "iris")
  titre = "Données iris"
  
  expect_error(ajouter_titre_tableau(classeur = nom_page,
                                     nom_feuille = "iris",
                                     titre = titre),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(ajouter_titre_tableau(classeur = mon_classeur,
                                     nom_feuille = "tab_iris",
                                     titre = iris),
               "Le titre doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_titre_tableau(classeur = mon_classeur,
                                     nom_feuille = iris,
                                     titre = titre),
               "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_titre_tableau(classeur = mon_classeur,
                                     nom_feuille = "iris",
                                     titre = titre,
                                     col_debut = "2"),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_titre_tableau(classeur = mon_classeur,
                                     nom_feuille = "iris",
                                     titre = titre,
                                     col_debut = 0),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_titre_tableau(classeur = mon_classeur,
                                     nom_feuille = "iris",
                                     titre = titre,
                                     col_debut = 2,
                                     format = 2),
               'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  expect_error(ajouter_titre_tableau(classeur = mon_classeur,
                                     nom_feuille = "iris",
                                     titre = titre,
                                     col_debut = 2,
                                     format ="chiffres_et_donnees",
                                     fusion = "oui"),
               "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")

})

test_that("Le titre est le bon dans le workbook", {
  mon_classeur <- openxlsx::createWorkbook()
  titre = "Données iris"
  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = iris, 
                        nom_feuille = "iris")
  ajouter_titre_tableau(classeur = mon_classeur,
                                     nom_feuille = "iris",
                                     titre = titre,
                                     col_debut = 2,
                                     format ="chiffres_et_donnees",
                                     fusion = TRUE)
  expect_true(openxlsx::readWorkbook(mon_classeur, colNames = FALSE, skipEmptyRows = FALSE)$X1[1] == titre)
})

```

## Ajouter une note de lecture

```{r function_ajouter_note_lecture}
#' Ajouter une note de lecture sous un tableau dans une feuille d'un fichier xlsx
#'
#' Cette fonction permet d'ajouter une note de lecture sous un tableau dans une feuille Excel
#'
#' @param classeur workbook créé avec openXLSX
#' @param nom_feuille nom de la feuille
#' @param note la note à écrire
#' @param format CHAR le type de publication : "chiffres_et_donnees" ou "primeur" 
#' @param col_debut la colonne de départ (2eme par défaut)
#' @param fusion LGL si les cellules sont à fusionner ou pas (TRUE par défaut)
#' @param avec_titre LGL si le classeur est un primeur avec un titre
#'
#' @return Rien n'est renvoyé mais la feuille du classeur est modifiée
#' 
#' @importFrom openxlsx writeData
#' @importFrom openxlsx addStyle
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx mergeCells
#' @importFrom openxlsx setRowHeights
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' 
#' @export
#'
#' @examples
ajouter_note_lecture <- function(classeur,
                                 nom_feuille,
                                 note,
                                 format = "chiffres_et_donnees",
                                 col_debut = 2,
                                 fusion = TRUE,
                                 avec_titre = FALSE) {
  
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(is.string(nom_feuille),
              msg = "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(is.string(note),
              msg = "La note doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(class(format) == "character",
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(format %in% c("chiffres_et_donnees", "primeur"),
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(class(fusion) == "logical",
              msg = "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  assert_that(class(avec_titre) == "logical",
              msg = "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")
  
  style <- creer_liste_style_excel(format = format)
  style_note <- style$note
  last_row <- nrow(readWorkbook(classeur, sheet = nom_feuille, skipEmptyRows = FALSE, colNames = FALSE))
  
  if (avec_titre == TRUE) {
    nb_row_to_add <- 0
  } else {
    nb_row_to_add <- row_to_add_format(format = format)
  }
  
  row_note <- last_row + 2 + nb_row_to_add
    
  nb_col = ncol(readWorkbook(classeur, sheet = nom_feuille))
  
  if (isTRUE(fusion)) {
    mergeCells(classeur, nom_feuille, cols = col_debut:(col_debut+nb_col-1), rows = row_note)
  }
  writeData(classeur, nom_feuille, paste("Note de lecture :", note), startCol = col_debut, startRow = row_note)
  addStyle(wb = classeur, sheet = nom_feuille, style = style_note, rows = row_note, cols = col_debut)
  setRowHeights(wb = classeur,
                sheet = nom_feuille,
                rows = row_note,
                heights = (1 + nchar(paste("Note de lecture :", note))%/%100)*15)
}
```

```{r examples_ajouter_note_lecture, eval=FALSE}

# Création d'un classeur avec une feuille contenant iris et une feuille contenant airquality
# Ajout d'une note de lecture
# Sauvegarde du classeur
# Ouverture du classeur
library(openxlsx)
library(agreste)
mon_classeur <- createWorkbook()

mes_styles <- creer_liste_style_excel()

start_ligne = 3
start_col = 2
nb_col = ncol(iris)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris")
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur, 
        sheet = "iris",
        style = mes_styles$decimal_italique,
        rows = (start_ligne+1):(nrow(iris)+start_ligne),
        cols = 5)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$texte,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 6)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "iris",
                      titre = "Iris",
                      col_debut = start_col,
                      format = "chiffres_et_donnees")

ajouter_note_lecture(classeur = mon_classeur,
                     nom_feuille = "iris",
                     note = "Ceci est une note de lecture",
                     col_debut = 2)

start_ligne = 3
start_col = 2
nb_col = ncol(airquality)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = airquality,
                      nom_feuille = "airquality")

addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 5)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 6)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 7)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "airquality",
                      titre = "Données qualité de l'air",
                      col_debut = 2)

ajouter_note_lecture(classeur = mon_classeur,
                     nom_feuille = "airquality",
                     note = "Ceci est une autre note de lecture",
                     col_debut = 2)

saveWorkbook(wb = mon_classeur, file = "tableau.xlsx", overwrite = TRUE)

browseURL("tableau.xlsx")

```


```{r tests_ajouter_note_lecture}
test_that("ajouter_note_lecture fonctionne correctement et renvoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()
  openxlsx::addWorksheet(mon_classeur, "iris")
  note = "Une note quelconque"
  
  expect_error(ajouter_note_lecture(classeur = note,
                                    nom_feuille = "iris",
                                    note = note),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(ajouter_note_lecture(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    note = iris),
               "La note doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_note_lecture(classeur = mon_classeur,
                                    nom_feuille = iris,
                                    note = note),
               "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_note_lecture(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    note = note,
                                    format = "info rapide"),
               'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  expect_error(ajouter_note_lecture(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    note = note,
                                    col_debut = "2"),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_note_lecture(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    note = note,
                                    col_debut = 0),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_note_lecture(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    note = note,
                                    col_debut = 2,
                                    fusion = "oui"),
               "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  expect_error(ajouter_note_lecture(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    note = note,
                                    col_debut = 2,
                                    avec_titre = "oui"),
               "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")
})

test_that("La note est bien présente dans le workbook et identique à celle rentrée en paramètre", {
  mon_classeur <- openxlsx::createWorkbook()

  note <- "Note de lecture"
  
  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = iris,
                        nom_feuille = "iris")
  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "iris",
                        titre = "Données Iris",
                        format = "primeur")
  ajouter_note_lecture(classeur = mon_classeur,
                       nom_feuille = "iris",
                       note = note,
                       format = "primeur",
                       avec_titre = FALSE)
  
  expect_equal(openxlsx::readWorkbook(mon_classeur, colNames = FALSE, skipEmptyRows = FALSE)$X1[dim(iris)[1]+3], paste("Note de lecture :", note))
})

```

## Ajouter la source

```{r function_ajouter_source}
#' Ajouter la source sous un tableau dans une feuille d'un fichier xlsx
#'
#' Cette fonction permet d'ajouter une source sous un tableau dans une feuille Excel
#'
#' @param classeur workbook créé avec openXLSX
#' @param nom_feuille nom de la feuille
#' @param source la source à ajouter
#' @param format CHAR le type de publication : "chiffres_et_donnees" ou "primeur" 
#' @param col_debut la colonne de départ (2eme par défaut)
#' @param avec_note si une note de lecture est présente ou pas, par défaut TRUE
#' @param fusion LGL si les cellules sont à fusionner ou pas (TRUE par défaut)
#' @param avec_titre LGL si le classeur est un primeur avec un titre
#'
#' @return Rien n'est renvoyé mais la feuille du classeur est modifiée
#' 
#' @importFrom openxlsx writeData
#' @importFrom openxlsx addStyle
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx mergeCells
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' 
#' @export
#'
#' @examples
ajouter_source <- function(classeur,
                           nom_feuille,
                           source,
                           format = "chiffres_et_donnees",
                           col_debut = 2,
                           avec_note = TRUE,
                           fusion = TRUE,
                           avec_titre = FALSE) {
  
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(is.string(nom_feuille),
              msg = "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(is.string(source),
              msg = "La source doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(class(format) == "character",
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(format %in% c("chiffres_et_donnees", "primeur"),
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(class(avec_note) == "logical",
              msg = "Le param\u00e8tre avec_note doit \u00eatre TRUE ou FALSE.")
  assert_that(class(fusion) == "logical",
              msg = "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  assert_that(class(avec_titre) == "logical",
              msg = "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")
  
  style = creer_liste_style_excel(format = format)
  style_source <- style$source
  last_row = nrow(readWorkbook(classeur, sheet = nom_feuille, skipEmptyRows = FALSE, colNames = FALSE))
  if (isTRUE(avec_note)) {
    ligne_de_depart_source = 0
  } else {
    ligne_de_depart_source = 1
  }
  
  if (avec_titre == TRUE) {
    nb_row_to_add <- 0
  } else {
    nb_row_to_add <- row_to_add_format(format = format)
  }
  
  row_source <- last_row + ligne_de_depart_source + 1 + nb_row_to_add

  nb_col = ncol(readWorkbook(classeur, sheet = nom_feuille))
  
  if (isTRUE(fusion)) {
    mergeCells(classeur, nom_feuille, cols = col_debut:(col_debut+nb_col-1), rows = row_source)
  }
  writeData(classeur, nom_feuille, paste("Source :",source), startCol = col_debut, startRow = row_source)
  addStyle(wb = classeur, sheet = nom_feuille, style = style_source, rows = row_source, cols = col_debut)
}
```

```{r examples_ajouter_source, eval=FALSE}

# Création d'un classeur avec une feuille contenant iris et une feuille contenant airquality
# Ajout de la source
# Sauvegarde du classeur
# Ouverture du classeur
library(openxlsx)
library(agreste)
mon_classeur <- createWorkbook()

mes_styles <- creer_liste_style_excel()

start_ligne = 3
start_col = 2
nb_col = ncol(iris)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris")
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur, 
        sheet = "iris",
        style = mes_styles$decimal_italique,
        rows = (start_ligne+1):(nrow(iris)+start_ligne),
        cols = 5)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$texte,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 6)
ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "iris",
                      titre = "Iris",
                      col_debut = start_col,
                      format = "chiffres_et_donnees")

ajouter_source(classeur = mon_classeur,
               nom_feuille = "iris",
               source = "Ceci est une source quelconque",
               format = "chiffres_et_donnees",
               col_debut = start_col,
               avec_note = FALSE)

start_ligne = 3
start_col = 2
nb_col = ncol(airquality)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = airquality,
                      nom_feuille = "airquality")

addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 5)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 6)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 7)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "airquality",
                      titre = "Données qualité de l'air",
                      col_debut = 2)

ajouter_note_lecture(classeur = mon_classeur,
                     nom_feuille = "airquality",
                     note = "blablabla",
                     col_debut = start_col)
ajouter_source(classeur = mon_classeur,
               nom_feuille = "airquality",
               source = "Eurostat",
               col_debut = start_col,
               avec_note = TRUE)

saveWorkbook(wb = mon_classeur,
             file = "tableau.xlsx",
             overwrite = TRUE)

browseURL("tableau.xlsx")

```


```{r tests_ajouter_source}
test_that("ajouter_source fonctionne correctement et renvoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()
  ajouter_tableau_excel(classeur = mon_classeur, 
                        nom_feuille = "iris",
                        tableau = iris)
  source = "Une note quelconque"
  expect_error(ajouter_source(classeur = source,
                              nom_feuille = "iris",
                              source = source,
                              avec_note = FALSE),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = "iris",
                              source = iris,
                              avec_note = FALSE),
               "La source doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = iris,
                              source = source,
                              avec_note = FALSE),
               "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = "iris",
                              source = source,
                              format = "info rapide",
                              avec_note = FALSE),
               'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = "iris",
                              source = source,
                              col_debut = "2",
                              avec_note = FALSE),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = "iris",
                              source = source,
                              col_debut = 0,
                              avec_note = FALSE),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = "iris",
                              source = source,
                              col_debut = 2,
                              fusion = "oui",
                              avec_note = FALSE),
               "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = "iris",
                              source = source,
                              col_debut = 2,
                              fusion = TRUE,
                              avec_note = "non"),
               "Le param\u00e8tre avec_note doit \u00eatre TRUE ou FALSE.")
  expect_error(ajouter_source(classeur = mon_classeur,
                              nom_feuille = "iris",
                              source = source,
                              col_debut = 2,
                              fusion = TRUE,
                              avec_note = FALSE,
                              avec_titre = "non"),
               "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")
})

test_that("La source est bien présente dans le workbook et identique à celle rentrée en paramètre", {
  mon_classeur <- openxlsx::createWorkbook()

  note <- "Une note de lecture"
  source <- "Une source quelconque"
  
  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = iris,
                        nom_feuille = "iris",
                        col_debut = 5)
  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "iris",
                        titre = "Données Iris",
                        format = "primeur")
  ajouter_note_lecture(classeur = mon_classeur,
                       nom_feuille = "iris",
                       note = note, 
                       format = "primeur",
                       avec_titre = FALSE)
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "iris",
                 source = source,
                 format = "primeur",
                 avec_note = TRUE,
                 avec_titre = FALSE)
  
  expect_equal(openxlsx::readWorkbook(mon_classeur, colNames = FALSE, skipEmptyRows = FALSE)$X1[dim(iris)[1]+4], paste("Source :", source))
})

```

## Ajouter le champ

```{r function_ajouter_champ}
#' Ajouter le champ sous un tableau dans une feuille d'un fichier xlsx
#'
#' Cette fonction permet d'ajouter un champ sous un tableau dans une feuille Excel
#'
#' @param classeur workbook créé avec openXLSX
#' @param nom_feuille nom de la feuille
#' @param champ le champ à ajouter
#' @param format CHAR le type de publication : "chiffres_et_donnees" ou "primeur" 
#' @param col_debut la colonne de départ (2eme par défaut)
#' @param fusion LGL si les cellules sont à fusionner ou pas (TRUE par défaut)
#' @param avec_titre LGL si le classeur est un primeur avec un titre
#'
#' @return Rien n'est renvoyé mais la feuille du classeur est modifiée
#' 
#' @importFrom openxlsx writeData
#' @importFrom openxlsx addStyle
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx mergeCells
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' 
#' @export
#'
#' @examples
ajouter_champ <- function(classeur,
                          nom_feuille,
                          champ,
                          format = "chiffres_et_donnees",
                          col_debut = 2,
                          fusion = TRUE,
                          avec_titre = FALSE) {
  
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(is.string(nom_feuille),
              msg = "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(is.string(champ),
              msg = "Le champ doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(class(format) == "character",
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(format %in% c("chiffres_et_donnees", "primeur"),
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(class(fusion) == "logical",
              msg = "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  assert_that(class(avec_titre) == "logical",
              msg = "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")
  
  style <- creer_liste_style_excel(format = format)
  style_champ <- style$champ
  last_row <- nrow(readWorkbook(classeur, sheet = nom_feuille, skipEmptyRows = FALSE, colNames = FALSE))
  
  if (avec_titre == TRUE) {
    nb_row_to_add <- 0
  } else {
    nb_row_to_add <- row_to_add_format(format = format)
  }
  
  row_champ <- last_row + 1 + nb_row_to_add

  nb_col = ncol(readWorkbook(classeur, sheet = nom_feuille))
  
  if (isTRUE(fusion)) {
    mergeCells(classeur, nom_feuille, cols = col_debut:(col_debut+nb_col-1), rows = row_champ)
  }
  writeData(classeur, nom_feuille, paste("Champ :",champ), startCol = col_debut, startRow = row_champ)
  addStyle(wb = classeur, sheet = nom_feuille, style = style_champ, rows = row_champ, cols = col_debut)
}
```

```{r examples_ajouter_champ, eval=FALSE}

# Création d'un classeur avec une feuille contenant iris et une feuille contenant airquality
# Ajout du champ
# Sauvegarde du classeur
# Ouverture du classeur
library(openxlsx)
library(agreste)
mon_classeur <- createWorkbook()

mes_styles <- creer_liste_style_excel(format = "chiffres_et_donnees")

start_ligne = 3
start_col = 2
nb_col = ncol(iris)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris")
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur, 
        sheet = "iris",
        style = mes_styles$decimal_italique,
        rows = (start_ligne+1):(nrow(iris)+start_ligne),
        cols = 5)
addStyle(wb = mon_classeur,
         sheet = "iris",
         style = mes_styles$texte,
         rows = (start_ligne+1):(nrow(iris)+start_ligne),
         cols = 6)
ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "iris",
                      titre = "Iris",
                      col_debut = start_col,
                      format = "chiffres_et_donnees")

ajouter_source(classeur = mon_classeur,
               nom_feuille = "iris",
               source = "Ceci est une source quelconque",
               col_debut = start_col,
               avec_note = FALSE)
ajouter_champ(classeur = mon_classeur,
              nom_feuille = "iris",
              champ = "France métropolitaine",
              col_debut = start_col)

start_ligne = 3
start_col = 2
nb_col = ncol(airquality)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = airquality,
                      nom_feuille = "airquality")

addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$ligne_titre,
         rows = start_ligne,
         cols = start_col:(nb_col+start_col-1))
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 2)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 3)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$decimal,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 4)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 5)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 6)
addStyle(wb = mon_classeur,
         sheet = "airquality",
         style = mes_styles$numerique,
         rows = (start_ligne+1):(nrow(airquality)+start_ligne),
         cols = 7)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "airquality",
                      titre = "Qualité de l'air",
                      col_debut = start_col)
ajouter_note_lecture(classeur = mon_classeur,
                     nom_feuille = "airquality",
                     note = "blablabla",
                     col_debut = start_col)
ajouter_source(classeur = mon_classeur,
               nom_feuille = "airquality",
               source = "Eurostat",
               col_debut = start_col,
               avec_note = TRUE)
ajouter_champ(classeur = mon_classeur,
              nom_feuille = "airquality",
              champ = "Daily air quality measurements in New York, May to September 1973.",
              col_debut = start_col)


saveWorkbook(wb = mon_classeur,
             file = "tableau.xlsx",
             overwrite = TRUE)

browseURL("tableau.xlsx")

```


```{r tests_ajouter_champ}
test_that("ajouter_champ fonctionne correctement et renvoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()
  ajouter_tableau_excel(classeur = mon_classeur, 
                        nom_feuille = "iris",
                        tableau = iris)
  champ = "Un champ de blé"
  
  expect_error(ajouter_champ(classeur = champ,
                                    nom_feuille = "iris",
                                    champ = champ),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(ajouter_champ(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    champ = iris),
               "Le champ doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_champ(classeur = mon_classeur,
                                    nom_feuille = iris,
                                    champ = champ),
               "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(ajouter_champ(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    champ = champ,
                                    format = "info rapide"),
               'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  expect_error(ajouter_champ(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    champ = champ,
                                    col_debut = "2"),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_champ(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    champ = champ,
                                    col_debut = 0),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(ajouter_champ(classeur = mon_classeur,
                                    nom_feuille = "iris",
                                    champ = champ,
                                    col_debut = 2,
                                    fusion = "oui"),
               "Le param\u00e8tre fusion doit \u00eatre TRUE ou FALSE.")
  expect_error(ajouter_champ(classeur = mon_classeur,
                             nom_feuille = "iris",
                             champ = champ,
                             col_debut = 2,
                             fusion = TRUE,
                             avec_titre = "non"),
               "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")
})

test_that("Le champ est bien présent dans le workbook et identique à celui rentré en paramètre", {
  mon_classeur <- openxlsx::createWorkbook()

  champ <- "Un champ de blé"
  
  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = iris,
                        nom_feuille = "iris",
                        ligne_debut = 5)
  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "iris",
                        titre = "Données Iris",
                        format = "primeur")
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "iris",
                 source = "Agreste",
                 format = "primeur",
                 avec_titre = FALSE)
  ajouter_champ(classeur = mon_classeur,
                nom_feuille = "iris",
                champ = champ,
                format = "primeur",
                avec_titre = FALSE)
  
  
  expect_equal(openxlsx::readWorkbook(mon_classeur,
                                      colNames = FALSE,
                                      skipEmptyRows = FALSE)$X1[dim(iris)[1]+5],
               paste("Champ :",
                     champ))
})

```

## Geler des lignes ou des colonnes

```{r function-geler}
#' Geler une(des) ligne(s) et/ou une(des) colonne(s) 
#'
#' Cette fonction permet de geler une ou plusieurs lignes ainsi qu'une ou plusieurs colonnes d'une feuille de classeur
#'
#' @param classeur workbook créé avec openXLSX
#' @param nom_feuille nom de la feuille
#' @param ligne la ligne à geler (0 si pas de ligne à geler)
#' @param col la colonne à geler (0 si pas de colonne à geler)
#'
#' @return Rien n'est renvoyé mais la feuille du classeur est modifiée
#' 
#' @importFrom openxlsx freezePane
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' 
#' @export
#'
#' @examples
geler <- function(classeur,
                  nom_feuille,
                  ligne = 0,
                  col = 0) {
  
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(is.string(nom_feuille),
              msg = "Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  assert_that(ligne >= 0,
              msg = "La ligne \u00e0 geler doit \u00eatre un entier positif.")
  assert_that(col >= 0,
              msg = "La colonne \u00e0 geler doit \u00eatre un entier positif.")
  assert_that(is.numeric(ligne),
              msg = "La ligne \u00e0 geler doit \u00eatre un entier positif.")
  assert_that(is.numeric(col),
              msg = "La colonne \u00e0 geler doit \u00eatre un entier positif.")
  
  ligne <- ligne + 1
  col <- col + 1
  
  freezePane(classeur, nom_feuille, firstActiveRow = ligne, firstActiveCol = col)

}
```

```{r examples-geler, eval=FALSE}

library(openxlsx)
library(agreste)

# Création d'un classeur avec une feuille contenant iris 
mon_classeur <- createWorkbook()
ajouter_tableau_excel(classeur = mon_classeur, tableau = iris, nom_feuille = "iris", ligne_debut = 3, col_debut = 2)

# gel 
geler(mon_classeur, "iris", ligne = 3, col = 1)

# Sauver le classeur
saveWorkbook(wb = mon_classeur, file = "tableau.xlsx", overwrite = TRUE)
# ouverture
browseURL("tableau.xlsx")
```


```{r tests-geler}
test_that("mon_classeur fonctionne correctement and envoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()
  nom_page <- "nom_onglet"
  openxlsx::addWorksheet(mon_classeur, "iris")

  expect_error(geler(classeur = nom_page, nom_feuille = "iris"),"Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(geler(classeur = mon_classeur, nom_feuille = iris),"Le nom de feuille doit \u00eatre une cha\u00eene de caract\u00e8re.")
  expect_error(geler(classeur = mon_classeur, nom_feuille = "iris", ligne = "1"),"La ligne \u00e0 geler doit \u00eatre un entier positif.")
  expect_error(geler(classeur = mon_classeur, nom_feuille = "iris", ligne = 1, col = "2"),"La colonne \u00e0 geler doit \u00eatre un entier positif.")
})
```

## Appliquer une taille de colonnes

```{r function-taille_colonnes}
#' Applique des tailles de colonne aux tableaux d'un workbook
#'
#' Cette fonction permet d'appliquer une taille de colonne choisie par 
#' l'utilisateur ou bien automatiquement, 
#' le total étant égal à 83, et les colonnes de texte étant plus larges 
#' que les autres en mode automatique
#'
#' @param classeur Le classeur excel, objet de type workbook
#' @param liste_type_donnees LIST liste de vecteurs contenant 
#' les types de données de chaque colonne
#' @param largeurs LIST liste de vecteurs contenant les largeurs colonne, 
#' "auto" pour appliquer des largeurs automatique
#' @param format CHAR le format de publication : "primeur" ou "chiffres_et_donnees"
#' @param col_debut La colonne à laquelle commencent les tableaux, par défaut 1
#' @param largeur_max LGL si le classeur doit respecter la largeur maximale des 
#' règles de diffusion (83 pour un chiffres et données)
#'
#' @return Rien n'est renvoyé mais le classeur est modifié
#' 
#' @importFrom assertthat assert_that
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx setColWidths
#' @importFrom comprehenr to_vec
#' @importFrom collections dict
#' 
#' @export
#'
#' @examples
taille_colonnes <- function(classeur, liste_type_donnees, largeurs, format, col_debut = 1, largeur_max = TRUE) {
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(class(liste_type_donnees) == "list",
              msg = "La liste des types de donn\u00e9es doit \u00eatre de type list.")
  for (i in 1:length(liste_type_donnees)) {
    for (j in 1:length(liste_type_donnees[[i]])) {
      assert_that(liste_type_donnees[[i]][j] %in% c("texte", "numerique", "decimal"),
              msg = "La liste des types de donn\u00e9es doit \u00eatre une liste contenant des vecteurs de cha\u00eenes de caract\u00e8re parmi 'texte', 'numerique' et 'decimal'.")
    }
  }
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(format %in% c("chiffres_et_donnees", "primeur"),
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(class(largeur_max) == "logical",
              msg = "Le param\u00e8tre largeur_max doit \u00eatre TRUE ou FALSE.")
  
  sheets <- names(classeur)
  
  indice_feuille <- 0
  
  pao_max <- 83
  weight_num <- 2
  
  for (sheet in sheets) {
    nb_col <- ncol(readWorkbook(classeur, sheet = sheet))
    indice_feuille <- indice_feuille + 1
    assert_that(((largeurs[[indice_feuille]][1] == "auto" | largeurs[[indice_feuille]][1] == 0) | class(largeurs[[indice_feuille]]) == "numeric"),
                msg = paste("Probl\u00e8me dans la colonne Taille_colonnes, tableau ",
                              indice_feuille,
                              ". Veuillez la v\u00e9rifier.",
                              sep = ""))
    if (largeurs[[indice_feuille]][1] == "auto" | largeurs[[indice_feuille]][1] == 0) {
      types <- liste_type_donnees[[indice_feuille]]
      mean_width <- round(pao_max/nb_col, digits = 2) - 0.01
      nb_text <- sum(to_vec(for(type in types) if(type == "texte") 1))
      nb_num <- nb_col - nb_text
      text_width <- mean_width + nb_num*weight_num/nb_text
      if ("texte" %in% types) {
        num_width <- mean_width - weight_num
      } else {
        num_width <- mean_width
      }
      
      d <- dict(keys = c("texte", "decimal", "numerique"),
                items = c(text_width, num_width, num_width))
      
      widths <- to_vec(for(type in types) d$get(type))
    } else {
      widths <- largeurs[[indice_feuille]]
    }
    
    if (format == "chiffres_et_donnees" & isTRUE(largeur_max)) {
      assert_that(sum(widths) <= pao_max,
                msg = paste("La largeur du tableau ne doit pas dépasser ",
                            pao_max,
                            ". Largeur actuelle : ",
                            sum(widths), ", tableau ", indice_feuille, sep = ""))
    }
    
    setColWidths(wb = classeur,
                 sheet = sheet,
                 cols = col_debut:(nb_col + col_debut - 1),
                 widths = widths)
  }
  
}
```

```{r examples-taille_colonne, eval=FALSE}
library(openxlsx)
library(agreste)

## Création d'un classeur avec deux feuilles et deux tableaux
mon_classeur <- createWorkbook()

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris",
                      ligne_debut = 5,
                      col_debut = 2)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "iris",
                      titre = "Données fleurs iris",
                      col_debut = 2,
                      format = "primeur")
ajouter_source(classeur = mon_classeur,
               nom_feuille = "iris",
               source = "Ceci est une source quelconque",
               format = "primeur",
               col_debut = 2,
               avec_note = FALSE,
               avec_titre = FALSE)
ajouter_champ(classeur = mon_classeur,
              nom_feuille = "iris",
              champ = "France métropolitaine",
              format = "primeur",
              col_debut = 2,
              avec_titre = FALSE)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = airquality,
                      nom_feuille = "airquality",
                      ligne_debut = 5,
                      col_debut = 2)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "airquality",
                      titre = "Données qualité de l'air",
                      col_debut = 2,
                      format = "primeur")
ajouter_note_lecture(classeur = mon_classeur,
                     nom_feuille = "airquality",
                     note = "blablabla",
                     format = "primeur",
                     col_debut = 2,
                     avec_titre = FALSE)
ajouter_source(classeur = mon_classeur,
               nom_feuille = "airquality",
               source = "Eurostat",
               format = "primeur",
               col_debut = 2,
               avec_note = TRUE,
               avec_titre = FALSE)
ajouter_champ(classeur = mon_classeur,
              nom_feuille = "airquality",
              champ = "Daily air quality measurements in New York, May to September 1973.",
              format = "primeur",
              col_debut = 2,
              avec_titre = FALSE)

ajouter_titre_primeur(classeur = mon_classeur,
                      titre = "Exemple 2022")

taille_colonnes(classeur = mon_classeur,
                liste_type_donnees = list(c("decimal",
                                            "decimal",
                                            "decimal",
                                            "decimal",
                                            "texte"),
                                          c("numerique",
                                            "numerique",
                                            "decimal",
                                            "numerique",
                                            "numerique",
                                            "numerique")),
                largeurs = list(c("auto"), c("auto")),
                format = "primeur",
                col_debut = 2)


## Sauver
saveWorkbook(wb = mon_classeur, file = "tableau.xlsx", overwrite = TRUE)

## Ouvrir
browseURL("tableau.xlsx")
```

```{r tests-taille_colonnes}
test_that("mon_classeur fonctionne correctement and envoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()
  nom_page <- "nom_onglet"
  openxlsx::addWorksheet(mon_classeur, "iris")
  openxlsx::addWorksheet(mon_classeur, "cars")
  openxlsx::writeData(wb = mon_classeur, sheet = "iris", x = iris)
  openxlsx::writeData(wb = mon_classeur, sheet = "cars", x = mtcars)

  expect_error(taille_colonnes(classeur = "mon_classeur",
                               liste_type_donnees = list(c("decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "texte"),
                                                          c("numerique",
                                                            "numerique",
                                                            "decimal",
                                                            "numerique",
                                                            "numerique",
                                                            "numerique")),
                                largeurs = list(c("auto"), c("auto")),
                                format = "primeur",
                                col_debut = 2),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(taille_colonnes(classeur = mon_classeur,
                               liste_type_donnees = "numerique",
                                largeurs = list(c("auto"), c("auto")),
                                format = "primeur",
                                col_debut = 2),
               "La liste des types de donn\u00e9es doit \u00eatre de type list.")
  
  expect_error(taille_colonnes(classeur = mon_classeur,
                               liste_type_donnees = list(c(5,
                                                           "decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "texte"),
                                                          c("numerique",
                                                            "numerique",
                                                            "decimal",
                                                            "numerique",
                                                            "numerique",
                                                            "numerique")),
                                largeurs = list(c("auto"), c("auto")),
                                format = "primeur",
                                col_debut = 2),
               "La liste des types de donn\u00e9es doit \u00eatre une liste contenant des vecteurs de cha\u00eenes de caract\u00e8re parmi 'texte', 'numerique' et 'decimal'.")
  expect_error(taille_colonnes(classeur = mon_classeur,
                               liste_type_donnees = list(c("decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "texte"),
                                                          c("numerique",
                                                            "numerique",
                                                            "decimal",
                                                            "numerique",
                                                            "numerique",
                                                            "numerique")),
                                largeurs = list(c("18"), c("auto")),
                                format = "primeur",
                                col_debut = 2),
               "Probl\u00e8me dans la colonne Taille_colonnes, tableau 1. Veuillez la v\u00e9rifier.")
  expect_error(taille_colonnes(classeur = mon_classeur,
                               liste_type_donnees = list(c("decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "texte"),
                                                          c("numerique",
                                                            "numerique",
                                                            "decimal",
                                                            "numerique",
                                                            "numerique",
                                                            "numerique")),
                                largeurs = list(c("auto"), c("20")),
                                format = "primeur",
                                col_debut = 2),
               "Probl\u00e8me dans la colonne Taille_colonnes, tableau 2. Veuillez la v\u00e9rifier.")
  expect_error(taille_colonnes(classeur = mon_classeur,
                               liste_type_donnees = list(c("decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "texte"),
                                                          c("numerique",
                                                            "numerique",
                                                            "decimal",
                                                            "numerique",
                                                            "numerique",
                                                            "numerique")),
                                largeurs = list(c("auto"), c("auto")),
                                format = "rep à la demande",
                                col_debut = 2),
               'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  expect_error(taille_colonnes(classeur = mon_classeur,
                               liste_type_donnees = list(c("decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "texte"),
                                                          c("numerique",
                                                            "numerique",
                                                            "decimal",
                                                            "numerique",
                                                            "numerique",
                                                            "numerique")),
                                largeurs = list(c("auto"), c("auto")),
                                format = "primeur",
                                col_debut = "B"),
               'La colonne de d\u00e9but doit \u00eatre un entier positif.')
  expect_error(taille_colonnes(classeur = mon_classeur,
                               liste_type_donnees = list(c("decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "decimal",
                                                           "texte"),
                                                          c("numerique",
                                                            "numerique",
                                                            "decimal",
                                                            "numerique",
                                                            "numerique",
                                                            "numerique")),
                                largeurs = list(c("auto"), c("auto")),
                                format = "primeur",
                                col_debut = 2,
                                largeur_max = "oui"),
               "Le param\u00e8tre largeur_max doit \u00eatre TRUE ou FALSE.")
})
```

## Formater un classeur automatiquement

```{r function-formater_auto}
#' Formater un classeur entier
#'
#' Cette fonction permet de formater tous les tableaux d'un classeur selon le type de publication choisi
#'
#' @param classeur workbook créé avec openXLSX
#' @param format CHAR le type de publication : 
#' "chiffres_et_donnees" ou "primeur"
#' @param liste_feuilles_avec_note vecteur contenant le nom de chaque 
#' feuille avec une note de lecture
#' @param col_debut NUM la colonne à laquelle les tableaux démarrent
#' @param liste_type_donnees LIST liste de vecteurs contenant les types de 
#' données de chaque colonne
#' @param liste_lignes_titre LIST liste des lignes de titres de colonnes 
#' @param liste_lignes_section LIST liste de vecteurs contenant les numéros des 
#' lignes du tableau qui sont des sections
#' @param liste_lignes_sous_total LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des sous-totaux
#' @param liste_lignes_precision_1 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 1
#' @param liste_lignes_precision_2 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 2
#' @param liste_lignes_precision_3 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 3
#' @param liste_lignes_precision_4 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 4
#' @param liste_lignes_total LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de totaux
#' @param liste_unif_unites VEC un vecteur de valeurs logiques pour indiquer 
#' les feuilles ayant des unités de colonnes différentes
#' @param liste_cellules_fusion LIST la liste des cellules à fusionner
#' @param avec_titre LGL si le classeur est un primeur avec un titre
#'
#' @return Rien n'est renvoyé mais le classeur est modifié
#' 
#' @importFrom openxlsx addStyle
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx createStyle
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' @importFrom readr parse_number
#' @importFrom readr locale
#' 
#' @export
#'
#' @examples
formater_auto <- function(classeur,
                          format,
                          liste_feuilles_avec_note,
                          liste_type_donnees,
                          liste_lignes_titre,
                          liste_lignes_section,
                          liste_lignes_sous_total,
                          liste_lignes_precision_1,
                          liste_lignes_precision_2,
                          liste_lignes_precision_3,
                          liste_lignes_precision_4,
                          liste_lignes_total,
                          liste_lignes_italique,
                          liste_unif_unites,
                          liste_cellules_fusion,
                          col_debut = 2,
                          avec_titre = FALSE) {
  
  assert_that(class(classeur) == "Workbook",
              msg = "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  assert_that(format %in% c("chiffres_et_donnees", "primeur"),
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  if (!is.null(liste_feuilles_avec_note)) {
    assert_that(class(liste_feuilles_avec_note) == "character",
              msg = "La liste des feuilles contenant une note de lecture doit \u00eatre un vecteur contenant des cha\u00eenes de caract\u00e8res.")
    for (feuille in liste_feuilles_avec_note) {
    assert_that(feuille %in% names(classeur),
                msg = paste("La feuille", feuille, "n'est pas une feuille existante."))
    }
  }

  
  assert_that(class(liste_type_donnees) == "list",
              msg = "La liste des types de donn\u00e9es doit \u00eatre de type list.")
  for(i in 1:length(liste_type_donnees)) {
    assert_that(class(liste_type_donnees[[i]]) == "character",
              msg = "La liste des types de donn\u00e9es doit \u00eatre une liste contenant des vecteurs de cha\u00eenes de caract\u00e8re.")
  }
  assert_that(class(liste_lignes_titre) == "list",
              msg = "La liste des lignes de titre doit \u00eatre de type list.")
  assert_that(class(liste_lignes_section) == "list",
              msg = "La liste des lignes de section doit \u00eatre de type list.")
  for (i in 1:length(liste_lignes_section)) {
    assert_that(class(liste_lignes_section[[i]]) == "numeric",
              msg = "La liste des lignes de section doit \u00eatre une liste contenant des vecteurs de nombres entiers.")
  }
  assert_that(class(liste_lignes_sous_total) == "list",
              msg = "La liste des lignes de sous-total doit \u00eatre de type list.")
  for (i in 1:length(liste_lignes_sous_total)) {
    assert_that(class(liste_lignes_sous_total[[i]]) == "numeric",
              msg = "La liste des lignes de sous-total doit \u00eatre une liste contenant des vecteurs de nombres entiers.")
  }
  assert_that(class(liste_lignes_precision_1) == "list",
              msg = "La liste des lignes de pr\u00e9cision doit \u00eatre de type list.")
  for (i in 1:length(liste_lignes_section)) {
    assert_that(class(liste_lignes_precision_1[[i]]) == "numeric",
              msg = "La liste des lignes de pr\u00e9cision doit \u00eatre une liste contenant des vecteurs de nombres entiers.")
  }
  assert_that(class(liste_lignes_total) == "list",
              msg = "La liste des lignes de total doit \u00eatre de type list.")
  for (i in 1:length(liste_lignes_total)) {
    assert_that(class(liste_lignes_total[[i]]) == "numeric",
              msg = "La liste des lignes de total doit \u00eatre une liste contenant des vecteurs de nombres entiers.")
  }
  
  assert_that(col_debut > 0,
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(is.numeric(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(class(avec_titre) == "logical",
              msg = "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")
  
  mes_styles <- creer_liste_style_excel(format = format)
  
  nb_row_to_add <- row_to_add_format(format = format)
  
  formater(classeur = classeur, 
           start_row_tabs = 3 + nb_row_to_add, 
           styles = mes_styles,
           liste_feuilles_avec_note = liste_feuilles_avec_note, 
           liste_type_donnees = liste_type_donnees,
           liste_lignes_titre = liste_lignes_titre,
           liste_lignes_section = liste_lignes_section,
           liste_lignes_sous_total = liste_lignes_sous_total,
           liste_lignes_precision_1 = liste_lignes_precision_1,
           liste_lignes_precision_2 = liste_lignes_precision_2,
           liste_lignes_precision_3 = liste_lignes_precision_3,
           liste_lignes_precision_4 = liste_lignes_precision_4,
           liste_lignes_total = liste_lignes_total,
           liste_lignes_italique = liste_lignes_italique,
           liste_unif_unites = liste_unif_unites,
           liste_cellules_fusion = liste_cellules_fusion,
           col_debut = col_debut,
           format = format,
           avec_titre = avec_titre)
}
```

```{r examples-formater_auto, eval=FALSE}
library(openxlsx)
library(agreste)

## Création d'un classeur avec deux feuilles et deux tableaux
mon_classeur <- createWorkbook()

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris",
                      ligne_debut = 5,
                      col_debut = 2)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "iris",
                      titre = "Données fleurs iris",
                      col_debut = 2,
                      format = "primeur")
ajouter_source(classeur = mon_classeur,
               nom_feuille = "iris",
               source = "Ceci est une source quelconque",
               format = "primeur",
               col_debut = 2,
               avec_note = FALSE,
               avec_titre = FALSE)
ajouter_champ(classeur = mon_classeur,
              nom_feuille = "iris",
              champ = "France métropolitaine",
              format = "primeur",
              col_debut = 2,
              avec_titre = FALSE)

ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = airquality,
                      nom_feuille = "airquality",
                      ligne_debut = 5,
                      col_debut = 2)

ajouter_titre_tableau(classeur = mon_classeur,
                      nom_feuille = "airquality",
                      titre = "Données qualité de l'air",
                      col_debut = 2,
                      format = "primeur")
ajouter_note_lecture(classeur = mon_classeur,
                     nom_feuille = "airquality",
                     note = "blablabla",
                     format = "primeur",
                     col_debut = 2,
                     avec_titre = FALSE)
ajouter_source(classeur = mon_classeur,
               nom_feuille = "airquality",
               source = "Eurostat",
               format = "primeur",
               col_debut = 2,
               avec_note = TRUE,
               avec_titre = FALSE)
ajouter_champ(classeur = mon_classeur,
              nom_feuille = "airquality",
              champ = "Daily air quality measurements in New York, May to September 1973.",
              format = "primeur",
              col_debut = 2,
              avec_titre = FALSE)

ajouter_titre_primeur(classeur = mon_classeur,
                      titre = "Exemple 2022")

taille_colonnes(classeur = mon_classeur,
                liste_type_donnees = list(c("decimal",
                                            "decimal",
                                            "decimal",
                                            "decimal",
                                            "texte"),
                                          c("numerique",
                                            "numerique",
                                            "decimal",
                                            "numerique",
                                            "numerique",
                                            "numerique")),
                largeurs = list(c("auto"), c("auto")),
                format = "primeur",
                col_debut = 2)

## Formater comme un Primeur
formater_auto(classeur = mon_classeur,
              format = "primeur",
              liste_feuilles_avec_note = c("airquality"),
              liste_type_donnees = list(c("decimal",
                                          "decimal",
                                          "decimal",
                                          "decimal",
                                          "texte"),
                                        c("numerique",
                                          "numerique",
                                          "decimal",
                                          "numerique",
                                          "numerique",
                                          "numerique")), 
              liste_lignes_titre = list(c(1), c(1)),
              liste_lignes_section = list(c(5, 9),
                                          c(3, 8)),
              liste_lignes_sous_total = list(c(4, 8),
                                             c(2, 7)),
              liste_lignes_precision_1 = list(c(2,3),
                                            c(0)),
              liste_lignes_precision_2 = list(c(0), c(0)),
              liste_lignes_precision_3 = list(c(0), c(0)),
              liste_lignes_precision_4 = list(c(0), c(0)),
              liste_lignes_total = list(c(150),
                                        c(100)),
              liste_lignes_italique = list(c(), c()),
              liste_unif_unites = c(TRUE, TRUE),
              liste_cellules_fusion = list(c(0), c(0)),
              col_debut = 2,
              avec_titre = TRUE)

## Sauver
saveWorkbook(wb = mon_classeur, file = "tableau.xlsx", overwrite = TRUE)

## Ouvrir
browseURL("tableau.xlsx")

```


```{r tests-formater_auto}
test_that("mon_classeur fonctionne correctement et renvoie une erreur quand il le faut", {
  mon_classeur <- openxlsx::createWorkbook()

  ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris",
                      col_debut = 2)

  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "iris",
                        titre = "Données fleurs iris",
                        col_debut = 2)
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "iris",
                 source = "Ceci est une source quelconque",
                 col_debut = 2,
                 avec_note = FALSE)
  ajouter_champ(classeur = mon_classeur,
                nom_feuille = "iris",
                champ = "France métropolitaine",
                col_debut = 2)

  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = airquality,
                        nom_feuille = "airquality",
                        col_debut = 2)

  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "airquality",
                        titre = "Données qualité de l'air",
                        col_debut = 2)
  ajouter_note_lecture(classeur = mon_classeur,
                       nom_feuille = "airquality",
                       note = "blablabla",
                       col_debut = 2)
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "airquality",
                 source = "Eurostat",
                 col_debut = 2,
                 avec_note = TRUE)
  ajouter_champ(classeur = mon_classeur,
                nom_feuille = "airquality",
                champ = "Daily air quality measurements in New York, May to September 1973.",
                col_debut = 2)


  expect_error(formater_auto(classeur = "workbook",
                             format = "chiffres_et_donnees",
                             liste_feuilles_avec_note = c("airquality"),
                             liste_type_donnees = list(c("decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "texte"),
                                                       c("numerique",
                                                         "numerique",
                                                         "decimal",
                                                         "numerique",
                                                         "numerique",
                                                         "numerique")),
                             liste_lignes_titre = list(c(1), c(1)),
                             liste_lignes_section = list(c(5, 9),
                                                          c(3, 8)),
                             liste_lignes_sous_total = list(c(4, 8),
                                                             c(2, 7)),
                             liste_lignes_precision_1 = list(c(2,3),
                                                            c(0)),
                             liste_lignes_precision_2 = list(c(0), c(0)),
                             liste_lignes_precision_3 = list(c(0), c(0)),
                             liste_lignes_precision_4 = list(c(0), c(0)),
                             liste_lignes_total = list(c(150),
                                                        c(100)),
                             liste_lignes_italique = list(c(), c()),
                             liste_unif_unites = c(TRUE, TRUE),
                             liste_cellules_fusion = list(c(0), c(0))),
               "Classeur doit \u00eatre un workbook. Lancer un createWorkbook avant de lancer l'ajout de tableau.")
  expect_error(formater_auto(classeur = mon_classeur,
                             format = 2,
                             liste_feuilles_avec_note = c("airquality"),
                             liste_type_donnees = list(c("decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "texte"),
                                                       c("numerique",
                                                         "numerique",
                                                         "decimal",
                                                         "numerique",
                                                         "numerique",
                                                         "numerique")),
                             liste_lignes_titre = list(c(1), c(1)),
                             liste_lignes_section = list(c(5, 9),
                                                          c(3, 8)),
                             liste_lignes_sous_total = list(c(4, 8),
                                                             c(2, 7)),
                             liste_lignes_precision_1 = list(c(2,3),
                                                            c(0)),
                             liste_lignes_precision_2 = list(c(0), c(0)),
                             liste_lignes_precision_3 = list(c(0), c(0)),
                             liste_lignes_precision_4 = list(c(0), c(0)),
                             liste_lignes_total = list(c(150),
                                                        c(100)),
                             liste_lignes_italique = list(c(), c()),
                             liste_unif_unites = c(TRUE, TRUE),
                             liste_cellules_fusion = list(c(0), c(0))),
               'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  expect_error(formater_auto(classeur = mon_classeur,
                             format = "chiffres_et_donnees",
                             liste_feuilles_avec_note = c(1,2,3),
                             liste_type_donnees = list(c("decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "texte"),
                                                       c("numerique",
                                                         "numerique",
                                                         "decimal",
                                                         "numerique",
                                                         "numerique",
                                                         "numerique")),
                             liste_lignes_titre = list(c(1), c(1)),
                             liste_lignes_section = list(c(5, 9),
                                                          c(3, 8)),
                             liste_lignes_sous_total = list(c(4, 8),
                                                             c(2, 7)),
                             liste_lignes_precision_1 = list(c(2,3),
                                                            c(0)),
                             liste_lignes_precision_2 = list(c(0), c(0)),
                             liste_lignes_precision_3 = list(c(0), c(0)),
                             liste_lignes_precision_4 = list(c(0), c(0)),
                             liste_lignes_total = list(c(150),
                                                        c(100)),
                             liste_lignes_italique = list(c(), c()),
                             liste_unif_unites = c(TRUE, TRUE),
                             liste_cellules_fusion = list(c(0), c(0))),
               "La liste des feuilles contenant une note de lecture doit \u00eatre un vecteur contenant des cha\u00eenes de caract\u00e8res.")
  expect_error(formater_auto(classeur = mon_classeur,
                             format = "chiffres_et_donnees",
                             liste_feuilles_avec_note = c("feuille 1"),
                             liste_type_donnees = list(c("decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "texte"),
                                                       c("numerique",
                                                         "numerique",
                                                         "decimal",
                                                         "numerique",
                                                         "numerique",
                                                         "numerique")),
                             liste_lignes_titre = list(c(1), c(1)),
                             liste_lignes_section = list(c(5, 9),
                                                          c(3, 8)),
                             liste_lignes_sous_total = list(c(4, 8),
                                                             c(2, 7)),
                             liste_lignes_precision_1 = list(c(2,3),
                                                            c(0)),
                             liste_lignes_precision_2 = list(c(0), c(0)),
                             liste_lignes_precision_3 = list(c(0), c(0)),
                             liste_lignes_precision_4 = list(c(0), c(0)),
                             liste_lignes_total = list(c(150),
                                                        c(100)),
                             liste_lignes_italique = list(c(), c()),
                             liste_unif_unites = c(TRUE, TRUE),
                             liste_cellules_fusion = list(c(0), c(0))),
               "La feuille feuille 1 n'est pas une feuille existante.")
  expect_error(formater_auto(classeur = mon_classeur,
                             format = "chiffres_et_donnees",
                             liste_feuilles_avec_note = c("airquality"),
                             liste_type_donnees = c("decimal",
                                                    "decimal",
                                                    "decimal",
                                                    "decimal",
                                                    "texte"),
                             liste_lignes_titre = list(c(1), c(1)),
                             liste_lignes_section = list(c(5, 9),
                                                          c(3, 8)),
                             liste_lignes_sous_total = list(c(4, 8),
                                                             c(2, 7)),
                             liste_lignes_precision_1 = list(c(2,3),
                                                            c(0)),
                             liste_lignes_precision_2 = list(c(0), c(0)),
                             liste_lignes_precision_3 = list(c(0), c(0)),
                             liste_lignes_precision_4 = list(c(0), c(0)),
                             liste_lignes_total = list(c(150),
                                                        c(100)),
                             liste_lignes_italique = list(c(), c()),
                             liste_unif_unites = c(TRUE, TRUE),
                             liste_cellules_fusion = list(c(0), c(0))),
               "La liste des types de donn\u00e9es doit \u00eatre de type list.")
  expect_error(formater_auto(classeur = mon_classeur,
                             format = "chiffres_et_donnees",
                             liste_feuilles_avec_note = c("airquality"),
                             liste_type_donnees = list(c("decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "texte"),
                                                       c("numerique",
                                                         "numerique",
                                                         "decimal",
                                                         "numerique",
                                                         "numerique",
                                                         "numerique")),
                             liste_lignes_titre = list(c(1), c(1)),
                             liste_lignes_section = list(c(5, 9),
                                                          c(3, 8)),
                             liste_lignes_sous_total = list(c(4, 8),
                                                             c(2, 7)),
                             liste_lignes_precision_1 = list(c(2,3),
                                                            c(0)),
                             liste_lignes_precision_2 = list(c(0), c(0)),
                             liste_lignes_precision_3 = list(c(0), c(0)),
                             liste_lignes_precision_4 = list(c(0), c(0)),
                             liste_lignes_total = list(c(150),
                                                        c(100)),
                             liste_lignes_italique = list(c(), c()),
                             liste_unif_unites = c(TRUE, TRUE),
                             liste_cellules_fusion = list(c(0), c(0)),
                             col_debut = "2"),
               "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  expect_error(formater_auto(classeur = mon_classeur,
                             format = "chiffres_et_donnees",
                             liste_feuilles_avec_note = c("airquality"),
                             liste_type_donnees = list(c("decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "decimal",
                                                         "texte"),
                                                       c("numerique",
                                                         "numerique",
                                                         "decimal",
                                                         "numerique",
                                                         "numerique",
                                                         "numerique")),
                             liste_lignes_titre =list(c(1), c(1)),
                             liste_lignes_section = list(c(5, 9),
                                                          c(3, 8)),
                             liste_lignes_sous_total = list(c(4, 8),
                                                             c(2, 7)),
                             liste_lignes_precision_1 = list(c(2,3),
                                                            c(0)),
                             liste_lignes_precision_2 = list(c(0), c(0)),
                             liste_lignes_precision_3 = list(c(0), c(0)),
                             liste_lignes_precision_4 = list(c(0), c(0)),
                             liste_lignes_total = list(c(150),
                                                        c(100)),
                             liste_lignes_italique = list(c(), c()),
                             liste_unif_unites = c(TRUE, TRUE),
                             liste_cellules_fusion = list(c(0), c(0)),
                             col_debut = 2,
                             avec_titre = "non"),
               "Le param\u00e8tre avec_titre doit \u00eatre TRUE ou FALSE.")

})

test_that("Le classeur est bien modifié pour un c&d", {
  mon_classeur <- openxlsx::createWorkbook()

  ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris",
                      col_debut = 2)

  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "iris",
                        titre = "Données fleurs iris",
                        col_debut = 2)
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "iris",
                 source = "Ceci est une source quelconque",
                 col_debut = 2,
                 avec_note = FALSE)
  ajouter_champ(classeur = mon_classeur,
                nom_feuille = "iris",
                champ = "France métropolitaine",
                col_debut = 2)

  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = airquality,
                        nom_feuille = "airquality",
                        col_debut = 2)

  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "airquality",
                        titre = "Données qualité de l'air",
                        col_debut = 2)
  ajouter_note_lecture(classeur = mon_classeur,
                       nom_feuille = "airquality",
                       note = "blablabla",
                       col_debut = 2)
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "airquality",
                 source = "Eurostat",
                 col_debut = 2,
                 avec_note = TRUE)
  ajouter_champ(classeur = mon_classeur,
                nom_feuille = "airquality",
                champ = "Daily air quality measurements in New York, May to September 1973.",
                col_debut = 2)
  
  expect_equal(length(openxlsx::getStyles(mon_classeur)), 7)
  
  formater_auto(classeur = mon_classeur,
                format = "chiffres_et_donnees",
                liste_feuilles_avec_note = c("airquality"),
                liste_type_donnees = list(c("decimal",
                                            "decimal",
                                            "decimal",
                                            "decimal",
                                            "texte"),
                                           c("numerique",
                                             "numerique",
                                             "decimal",
                                             "numerique",
                                             "numerique",
                                             "numerique")),
                 liste_lignes_titre = list(c(1), c(1)),
                 liste_lignes_section = list(c(5, 9),
                                              c(3, 8)),
                 liste_lignes_sous_total = list(c(4, 8),
                                                 c(2, 7)),
                 liste_lignes_precision_1 = list(c(2,3),
                                                c(0)),
                 liste_lignes_precision_2 = list(c(0), c(0)),
                 liste_lignes_precision_3 = list(c(0), c(0)),
                 liste_lignes_precision_4 = list(c(0), c(0)),
                 liste_lignes_total = list(c(150),
                                            c(100)),
                liste_lignes_italique = list(c(), c()),
                 liste_unif_unites = c(TRUE, TRUE),
                 liste_cellules_fusion = list(c(0), c(0)))
  expect_equal(length(openxlsx::getStyles(mon_classeur)), 76)
})

test_that("Le classeur est bien modifié pour un primeur", {
  mon_classeur <- openxlsx::createWorkbook()

  ajouter_tableau_excel(classeur = mon_classeur,
                      tableau = iris,
                      nom_feuille = "iris",
                      col_debut = 2,
                      ligne_debut = 5)

  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "iris",
                        titre = "Données fleurs iris",
                        col_debut = 2,
                        format = "primeur")
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "iris",
                 source = "Ceci est une source quelconque",
                 col_debut = 2,
                 avec_note = FALSE,
                 format = "primeur",
                 avec_titre = FALSE)
  ajouter_champ(classeur = mon_classeur,
                nom_feuille = "iris",
                champ = "France métropolitaine",
                col_debut = 2,
                format = "primeur",
                avec_titre = FALSE)

  ajouter_tableau_excel(classeur = mon_classeur,
                        tableau = airquality,
                        nom_feuille = "airquality",
                        col_debut = 2,
                        ligne_debut = 5)

  ajouter_titre_tableau(classeur = mon_classeur,
                        nom_feuille = "airquality",
                        titre = "Données qualité de l'air",
                        col_debut = 2,
                        format = "primeur")
  ajouter_note_lecture(classeur = mon_classeur,
                       nom_feuille = "airquality",
                       note = "blablabla",
                       col_debut = 2,
                       format = "primeur")
  ajouter_source(classeur = mon_classeur,
                 nom_feuille = "airquality",
                 source = "Eurostat",
                 col_debut = 2,
                 avec_note = TRUE,
                 format = "primeur")
  ajouter_champ(classeur = mon_classeur,
                nom_feuille = "airquality",
                champ = "Daily air quality measurements in New York, May to September 1973.",
                col_debut = 2,
                format = "primeur")
  ajouter_titre_primeur(classeur = mon_classeur,
                                 titre = "Exemple")
  
  expect_equal(length(openxlsx::getStyles(mon_classeur)), 9)
  
  formater_auto(classeur = mon_classeur,
                format = "primeur",
                liste_feuilles_avec_note = c("airquality"),
                liste_type_donnees = list(c("decimal",
                                            "decimal",
                                            "decimal",
                                            "decimal",
                                            "texte"),
                                           c("numerique",
                                             "numerique",
                                             "decimal",
                                             "numerique",
                                             "numerique",
                                             "numerique")),
                 liste_lignes_titre = list(c(1), c(1)),
                 liste_lignes_section = list(c(5, 9),
                                              c(3, 8)),
                 liste_lignes_sous_total = list(c(4, 8),
                                                 c(2, 7)),
                 liste_lignes_precision_1 = list(c(2,3),
                                                c(0)),
                 liste_lignes_precision_2 = list(c(0), c(0)),
                 liste_lignes_precision_3 = list(c(0), c(0)),
                 liste_lignes_precision_4 = list(c(0), c(0)),
                 liste_lignes_total = list(c(150),
                                            c(100)),
                liste_lignes_italique = list(c(), c()),
                 liste_unif_unites = c(TRUE, TRUE),
                 liste_cellules_fusion = list(c(0), c(0)))
  expect_equal(length(openxlsx::getStyles(mon_classeur)), 76)
})
```

```{r function-formater}
#' Formater un classeur 
#'
#' @param classeur workbook créé avec openXLSX
#' @param start_row_tabs la ligne de départ des tableaux
#' @param styles une liste de Styles
#' @param liste_feuilles_avec_note vecteur contenant le nom de chaque feuille 
#' avec une note de lecture
#' @param liste_type_donnees LIST liste de vecteurs contenant les types de 
#' données de chaque colonne
#' @param liste_lignes_titre LIST liste des lignes de titres de colonnes 
#' @param liste_lignes_section LIST liste de vecteurs contenant les numéros des 
#' lignes du tableau qui sont des sections
#' @param liste_lignes_sous_total LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des sous-totaux
#' @param liste_lignes_precision_1 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 1
#' @param liste_lignes_precision_2 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 2
#' @param liste_lignes_precision_3 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 3
#' @param liste_lignes_precision_4 LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de précision de niveau 4
#' @param liste_lignes_total LIST liste des vecteurs contenant les numéros
#' des lignes du tableau qui sont des lignes de totaux
#' @param liste_unif_unites VEC un vecteur de valeurs logiques pour indiquer 
#' les feuilles ayant des unités de colonnes différentes
#' @param liste_cellules_fusion LIST la liste des cellules à fusionner
#' @param col_debut NUM la colonne à laquelle les tableaux démarrent
#' @param format CHAR le format entre "chiffres_et_donnees" ou "primeur"
#' @param avec_titre LGL si le classeur est un primeur avec un titre
#'
#' @return Rien n'est renvoyé mais le classeur est modifié
formater <- function(classeur,
                     start_row_tabs,
                     styles,
                     liste_feuilles_avec_note,
                     liste_type_donnees,
                     liste_lignes_titre,
                     liste_lignes_section,
                     liste_lignes_sous_total,
                     liste_lignes_precision_1,
                     liste_lignes_precision_2,
                     liste_lignes_precision_3,
                     liste_lignes_precision_4,
                     liste_lignes_total,
                     liste_lignes_italique,
                     liste_unif_unites,
                     liste_cellules_fusion,
                     format,
                     col_debut = 2,
                     avec_titre = FALSE) {
  
  if (avec_titre == TRUE) {
    nb_row_to_add <- 0
  } else {
    nb_row_to_add <- row_to_add_format(format = format)
  }
  
  ligne_supp_debut_cd <- switch (format,
        "chiffres_et_donnees" = 1,
        "primeur" = 0
      )
  header_start = start_row_tabs
  start_row_tabs = start_row_tabs + ligne_supp_debut_cd
  
  style_section <- styles$texte_section
  style_precision_1 <- styles$precision_texte_1
  style_precision_2 <- styles$precision_texte_2
  style_precision_3 <- styles$precision_texte_3
  style_precision_4 <- styles$precision_texte_4
  i <- 0
  print("Formatage...")
  pb_format <- txtProgressBar(min = 0, max = length(names(classeur)), style = 3)
  for (feuille in names(classeur)) {
    i <- i + 1
    max_ligne_titre <- max(liste_lignes_titre[[i]])
    if (isTRUE(liste_unif_unites[i])) {
      shift_rows <- 0
      if (format == "chiffres_et_donnees") {
        shift_headers <- 1
      } else {
        shift_headers <- 0
      }
      
    } else {
      shift_headers <- 0
      if (format == "primeur") {
        shift_rows <- 1
      } else {
        shift_rows <- 0
      }
    }
    nb_col <- ncol(readWorkbook(classeur, sheet = feuille))
    last_row <- nrow(readWorkbook(classeur, sheet = feuille, skipEmptyRows = FALSE, colNames = FALSE))
    if (feuille %in% liste_feuilles_avec_note) {
      eff_last_row <- last_row - 4 + nb_row_to_add
    } else {
      eff_last_row <- last_row - 3 + nb_row_to_add
    }
    for (line in liste_lignes_titre[[i]]) {
      addStyle(wb = classeur,
             sheet = feuille,
             style = styles$ligne_titre,
             rows = line + header_start + shift_headers - 1,
             cols = col_debut:(nb_col + col_debut - 1),
             stack = TRUE)
    }
    
    for (num_col in col_debut:(nb_col + col_debut - 1)) {
      j <- num_col - col_debut + 1
  
      assert_that(liste_type_donnees[[i]][j] %in% c("texte", "numerique", "decimal"),
                  msg = paste("Format de donn\u00e9es", liste_type_donnees[[i]][j], "non valide."))
  
      style_data <- switch (liste_type_donnees[[i]][j],
        "texte" = styles$texte,
        "numerique" = styles$numerique,
        "decimal" = styles$decimal
      )
      style_data_italique <- switch (liste_type_donnees[[i]][j],
         "texte" = styles$texte_italique,
         "numerique" = styles$numerique_italique,
         "decimal" = styles$decimal_italique
      )
      style_sous_total <- switch (liste_type_donnees[[i]][j],
        "texte" = styles$texte_sous_total,
        "numerique" = styles$numerique_sous_total,
        "decimal" = styles$decimal_sous_total
      )
      style_total <- switch (liste_type_donnees[[i]][j],
        "texte" = styles$texte_total,
        "numerique" = styles$numerique_total,
        "decimal" = styles$decimal_total
      )
      
      
      r <- 0
      
      col_data = readWorkbook(xlsxFile = classeur,
                              sheet = feuille,
                              rows = (start_row_tabs + max_ligne_titre + shift_rows - 1):eff_last_row,
                              cols = num_col,
                              colNames = FALSE,
                              skipEmptyRows = FALSE)$X1

      for (row in (start_row_tabs + max_ligne_titre + shift_rows - 1):eff_last_row) {
        r <- r + 1
        if (liste_type_donnees[[i]][j] %in% c("numerique", "decimal")) {
          if (class(col_data[r]) != "numeric") {
            if ((substr(col_data[r], 1, 1) %in% c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9")) | ((nchar(col_data[r]) >= 2) & (substr(col_data[r], 1, 2) %in% c("-1", "-2", "-3", "-4", "-5", "-6", "-7", "-8", "-9")))) {
              x <- as.numeric(col_data[r])
              writeData(wb = classeur, 
                        sheet = feuille,
                        x = x,
                        startCol = num_col,
                        startRow = row)
            }
          }
        }
      }
      
      addStyle(wb = classeur,
               sheet = feuille,
               style = style_data,
               rows = ((start_row_tabs + max_ligne_titre + shift_rows):eff_last_row),
               cols = num_col,
               stack = TRUE)
      if (!(0 %in% liste_lignes_italique[[i]])) {
        addStyle(wb = classeur,
                 sheet = feuille,
                 style = style_data_italique,
                 rows = liste_lignes_italique[[i]] + start_row_tabs + shift_rows,
                 cols = num_col,
                 stack = TRUE)
      }
      if (!(0 %in% liste_lignes_sous_total[[i]])) {
        addStyle(wb = classeur,
               sheet = feuille,
               style = style_sous_total,
               rows = liste_lignes_sous_total[[i]] + start_row_tabs + shift_rows,
               cols = num_col,
               stack = TRUE)
      }
      
      if (!(0 %in% liste_lignes_total[[i]])) {
        addStyle(wb = classeur,
               sheet = feuille,
               style = style_total,
               rows = liste_lignes_total[[i]] + start_row_tabs + shift_rows,
               cols = num_col,
               stack = TRUE)
      }
      
    }
    if ((eff_last_row - start_row_tabs - shift_rows) %in% liste_lignes_total[[i]]) {
      if (format == "chiffres_et_donnees") {
        addStyle(wb = classeur,
             sheet = feuille,
             style = createStyle(border = "top",
                                 borderColour = "black"),
             rows = eff_last_row,
             cols = col_debut:(nb_col + col_debut - 1),
             stack = TRUE)
      }
    }
    
    addStyle(wb = classeur,
             sheet = feuille,
             style = createStyle(border = "bottom",
                                 borderColour = "black"),
             rows = eff_last_row,
             cols = col_debut:(nb_col + col_debut - 1),
             stack = TRUE)
    
    if (!(0 %in% liste_lignes_precision_1[[i]])) {
      addStyle(wb = classeur,
               sheet = feuille,
               style = style_precision_1,
               rows = liste_lignes_precision_1[[i]] + start_row_tabs + shift_rows,
               cols = col_debut,
               stack = TRUE)
    }
    
    if (!(0 %in% liste_lignes_precision_2[[i]])) {
      addStyle(wb = classeur,
               sheet = feuille,
               style = style_precision_2,
               rows = liste_lignes_precision_2[[i]] + start_row_tabs + shift_rows,
               cols = col_debut,
               stack = TRUE)
    }
    
    if (!(0 %in% liste_lignes_precision_3[[i]])) {
      addStyle(wb = classeur,
               sheet = feuille,
               style = style_precision_3,
               rows = liste_lignes_precision_3[[i]] + start_row_tabs + shift_rows,
               cols = col_debut,
               stack = TRUE)
    }
    
    if (!(0 %in% liste_lignes_precision_4[[i]])) {
      addStyle(wb = classeur,
               sheet = feuille,
               style = style_precision_4,
               rows = liste_lignes_precision_4[[i]] + start_row_tabs + shift_rows,
               cols = col_debut,
               stack = TRUE)
    }
    
    if (!(0 %in% liste_lignes_section[[i]])) {
      for (row_n in liste_lignes_section[[i]] + start_row_tabs + shift_rows) {
        for (col_n in col_debut:(nb_col + col_debut - 1)) {
          addStyle(wb = classeur,
               sheet = feuille,
               style = style_section,
               rows = row_n,
               cols = col_n,
               stack = TRUE)
        }
      }
      
      for (merge_row in liste_lignes_section[[i]]) {
        mergeCells(wb = classeur,
                 sheet = feuille,
                 cols = col_debut:(nb_col + col_debut - 1),
                 rows = merge_row + start_row_tabs - max_ligne_titre + shift_rows + 1)
      }
      
    }
    
    if (!(0 %in% liste_cellules_fusion[[i]])) {
      for (step1 in liste_cellules_fusion[[i]]) {
      step2 <- unlist(strsplit(step1, split = ";"))
      assert_that(length(step2) == 2,
                  msg = paste("Probl\u00e8me dans la colonne Cellules_a_fusionner, tableau ",
                              i,
                              ". Veuillez la v\u00e9rifier.",
                              sep = ""))
      l_row = eval(parse(text = substr(step2[1], 2, nchar(step2[1]))))
      if (l_row[1] %in% liste_lignes_titre[[i]]) {
        rows = l_row + header_start + shift_headers - 1
      } else {
        rows <- l_row + start_row_tabs + shift_rows - 1
      }
      cols <- eval(parse(text = substr(step2[2], 1, nchar(step2[2]) - 1))) + col_debut - 1
      mergeCells(wb = classeur,
                 sheet = feuille,
                 cols = cols,
                 rows = rows)
      }
    }
    setTxtProgressBar(pb_format, i)
  }
  close(pb_format)
}
```

# Créer un tableau excel formaté depuis un plan

Cette fonction permet de formater un ensemble de tableaux dans un classeur Excel, en suivant un plan défini, qui indique comment formater chaque tableau : largeurs et types de colonnes, de lignes, titre, source...

```{r function-creer_excel_depuis_plan}
#' Crée un classeur et le formate
#'
#' Cette fonction permet de formater tous les tableaux d'un classeur selon le
#' type de publication choisi, simplement à partir d'un plan. Les fichiers
#' indiqués dans le plan doivent être dans le répertoire de travail.
#'
#' @param plan fichier .xlsx ou data frame contenant les détails pour chaque
#' tableau 
#' @param format CHAR le type de publication : "chiffres_et_donnees"
#' ou "primeur"
#' @param col_debut NUM la colonne à laquelle les tableaux démarrent, NULL pour 
#' automatiquement déterminée selon le format
#' @param datadir CHAR le chemin vers le dossier contenant les données. Dossier
#' de travail actif si non spécifié.
#' @param sep CHAR le caractère utilisé pour séparer les colonnes des fichiers
#' @param type_virgule CHAR le type de séparation décimale utilisée : "." ou ","
#' @param save LGL TRUE si export du classeur au format xlsx
#' @param path CHAR chemin vers le tableau à sauvegarder
#' @param largeur_max LGL si le classeur doit respecter la largeur maximale des 
#' règles de diffusion (83 pour un chiffres et données)
#'
#' @return un objet de type workbook formaté
#' 
#' @importFrom assertthat assert_that
#' @importFrom assertthat is.string
#' @importFrom openxlsx read.xlsx
#' @importFrom openxlsx createWorkbook
#' @importFrom openxlsx saveWorkbook
#' @importFrom openxlsx write.xlsx
#' @importFrom openxlsx writeData
#' @importFrom openxlsx addStyle
#' @importFrom openxlsx readWorkbook
#' @importFrom openxlsx mergeCells
#' @importFrom openxlsx addWorksheet
#' @importFrom openxlsx worksheetOrder
#' @importFrom openxlsx worksheetOrder<-
#' @importFrom openxlsx writeFormula
#' @importFrom openxlsx makeHyperlinkString
#' @importFrom stringr str_trim
#' 
#' @export
#'
#' @examples
creer_excel_depuis_plan <- function(plan,
                                    format,
                                    col_debut = NULL,
                                    datadir = NULL,
                                    sep = ",",
                                    type_virgule = ",",
                                    save = TRUE,
                                    path = "tableau1.xlsx",
                                    utiliser_largeur_max = TRUE) {
  
  assert_that(class(plan) %in% c("character", "data.frame"),
              msg = "Le plan doit \u00eatre une cha\u00eene de caract\u00e8res ou un data frame.")
  assert_that(format %in% c("chiffres_et_donnees", "primeur"),
              msg = 'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  assert_that(type_virgule %in% c(",", "."),
              msg = 'Le type de virgule doit \u00eatre "." ou ","')
  assert_that(is.numeric(col_debut) | is.null(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre NULL ou bien un entier positif.")
  assert_that(col_debut > 0 | is.null(col_debut),
              msg = "La colonne de d\u00e9but doit \u00eatre un entier positif.")
  assert_that(class(datadir) == "character" | is.null(datadir),
              msg = "Le dossier contenant les donn\u00e9es doit \u00eatre une cha\u00eene de caract\u00e8res ou NULL.")
  assert_that(sep %in% c(",", ";", "\t"),
              msg = 'Le s\u00e9parateur doit \u00eatre parmi ",", ";" et "\t".')
  assert_that(type_virgule %in% c(",", "."),
              msg = 'Le s\u00e9parateur d\u00e9cimal doit \u00eatre "," ou ".".')
  assert_that(class(save) == "logical",
              msg = "save doit \u00eatre TRUE ou FALSE")
  assert_that(class(path) == "character",
              msg = "Le chemin du fichier \u00e0 sauvegarder doit \u00eatre une cha\u00eene de caract\u00e8res.")
  
  if (class(plan) == "character") {
    plan = read.xlsx(plan,
                     colNames = TRUE,
                     rowNames = FALSE)
  }
  if (is.null(col_debut)) {
    col_debut <- switch (format,
      "chiffres_et_donnees" = 1,
      "primeur" = 2
    )
  }
  i <- 0
  for (liste in plan$Type_colonnes) {
    i <- i + 1
    test_list <- strsplit(liste,
                     split = ", ")[[1]]
    for (type in test_list) {
      assert_that(type %in% c("decimal", "texte", "numerique"),
                  msg = paste("Probl\u00e8me dans la colonne Type_colonnes, tableau ", i, ". Veuillez la v\u00e9rifier.", sep = ""))
    }
  }
  
  
  plan[,14:23][is.na(plan[,14:23])] <- 0
  plan[,1:13][is.na(plan[,1:13])] <- ""
  nb_tab = nrow(plan)
  
  ligne_debut <- 3 + row_to_add_format(format = format)
  
  liste_feuilles_note <- c()
  liste_data_types <- list()
  liste_lignes_titre <- c()
  liste_lignes_section <- list()
  liste_lignes_sous_total <- list()
  liste_lignes_precision_1 <- list()
  liste_lignes_precision_2 <- list()
  liste_lignes_precision_3 <- list()
  liste_lignes_precision_4 <- list()
  liste_lignes_total <- list()
  liste_col_widths <- list()
  liste_lignes_italique <- list()
  liste_unif_unites <- c()
  liste_cells_to_merge <- list()
  
  styles <- creer_liste_style_excel(format = format)
  titre_doc = plan$Titre_document[1]
  
  wb = createWorkbook()
  
  ligne_supp_debut_cd <- switch (format,
        "chiffres_et_donnees" = 1,
        "primeur" = 0
      )
  
  print("Ecriture...")
  pb_ecriture <- txtProgressBar(min = 0, max = nb_tab, style = 3)
  for (tab in 1:nb_tab) {
    filename <- paste(plan$Nom_fichier[tab],
                      plan$Type[tab],
                      sep = ".")
    if (datadir == "" | is.null(datadir)) {
      datadir <- getwd()
    }
    complete_filename <- paste(datadir, filename, sep = "/")
    data <- read_any_file(filename = complete_filename,
                          header = TRUE,
                          sep = sep,
                          decimal_mark = type_virgule)
    feuille <- plan$Nom_feuille[tab]
    titre <- plan$Titre[tab]
    if (str_trim(plan$Note_de_lecture[tab]) == "" | is.na(plan$Note_de_lecture[tab])) {
      avec_note <- FALSE
    } else {
      avec_note <- TRUE
    }
    source <- plan$Source[tab]
    champ <- plan$Champ[tab]
    if (str_trim(plan$Taille_colonnes[tab]) == "auto") {
      liste_col_widths <- append(liste_col_widths, "auto")
    } else {
      liste_col_widths <- append(liste_col_widths,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Taille_colonnes[tab]), split = ", ")))))
    }
    liste_data_types <- append(liste_data_types,
                               strsplit(plan$Type_colonnes[tab],
                                        split = ", "))
    liste_lignes_titre <- append(liste_lignes_titre,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_titre[tab]), split = ", ")))))
    liste_lignes_section <- append(liste_lignes_section,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_section[tab]), split = ", ")))))
    liste_lignes_sous_total <- append(liste_lignes_sous_total,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_sous_total[tab]), split = ", ")))))
    liste_lignes_precision_1 <- append(liste_lignes_precision_1,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_precision_1[tab]), split = ", ")))))
    liste_lignes_precision_2 <- append(liste_lignes_precision_2,
                               list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_precision_2[tab]), split = ", ")))))
    liste_lignes_precision_3 <- append(liste_lignes_precision_3,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_precision_3[tab]), split = ", ")))))
    liste_lignes_precision_4 <- append(liste_lignes_precision_4,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_precision_4[tab]), split = ", ")))))
    liste_lignes_total <- append(liste_lignes_total,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_total[tab]), split = ", ")))))
    liste_lignes_italique <- append(liste_lignes_italique,
                                 list(as.numeric(unlist(strsplit(str_trim(plan$Lignes_italique[tab]), split = ", ")))))
    liste_unites <- unlist(strsplit(plan$Liste_unites[tab], split = ","))
    
    liste_cells_to_merge <- append(liste_cells_to_merge,
                                   strsplit(as.character(plan$Cellules_a_fusionner[tab]), ", "))
    
    if (length(liste_unites) > 1) {
      max_ligne_titre <- max(liste_lignes_titre[[tab]])
      liste_unif_unites <- append(liste_unif_unites, FALSE)
      if (length(liste_unites) != ncol(data)) {
        liste_unites <- c(liste_unites, " ")
      }
      data[seq(max_ligne_titre + 1,nrow(data)+1),] <- 
        data[seq(max_ligne_titre,nrow(data)),]
      data[max_ligne_titre,] <- liste_unites
      ajouter_tableau_excel(classeur = wb,
                                   tableau = data,
                                   nom_feuille = feuille,
                                   ligne_debut = ligne_debut,
                                   col_debut = col_debut)

    } else {
      liste_unif_unites <- append(liste_unif_unites, TRUE)
      ajouter_tableau_excel(classeur = wb,
                                   tableau = data,
                                   nom_feuille = feuille,
                                   ligne_debut = ligne_debut + ligne_supp_debut_cd,
                                   col_debut = col_debut)
      mergeCells(wb = wb,
                 sheet = feuille,
                 cols = col_debut:(ncol(data) + col_debut - 1),
                 rows = ligne_debut + ligne_supp_debut_cd - 1)
      writeData(wb = wb,
                sheet = feuille,
                x = liste_unites[1],
                startRow = ligne_debut + ligne_supp_debut_cd - 1,
                startCol = col_debut)
      addStyle(wb = wb,
               sheet = feuille,
               style = styles$lignes_unite_uniforme,
               rows = ligne_debut + ligne_supp_debut_cd - 1,
               cols = col_debut,
               stack = TRUE)
      
    }
    
    
    
    
    ajouter_titre_tableau(classeur = wb,
                                   nom_feuille = feuille,
                                   titre = titre,
                                   col_debut = col_debut,
                                   format = format)
    if (isTRUE(avec_note)) {
      liste_feuilles_note <- append(liste_feuilles_note, feuille)
      ajouter_note_lecture(classeur = wb,
                                    nom_feuille = feuille,
                                    note = plan$Note_de_lecture[tab],
                                    col_debut = col_debut,
                                    format = format)
    } 
    
    ajouter_source(classeur = wb,
                              nom_feuille = feuille,
                              source = source,
                              col_debut = col_debut,
                              avec_note = avec_note,
                              format = format)
    ajouter_champ(classeur = wb,
                           nom_feuille = feuille,
                           champ = champ,
                           col_debut = col_debut,
                           format = format)
    
    setTxtProgressBar(pb_ecriture, tab)
  }
  close(pb_ecriture)
  if (format == "primeur") {
      ajouter_titre_primeur(classeur = wb,
                                     titre = titre_doc,
                                     col_debut = col_debut,
                                     fusion = TRUE)
  }
  taille_colonnes(classeur = wb,
                  liste_type_donnees = liste_data_types,
                  largeurs = liste_col_widths,
                  format = format,
                  col_debut = col_debut,
                  largeur_max = utiliser_largeur_max)
  formater_auto(wb,
                format = format,
                liste_feuilles_avec_note = liste_feuilles_note,
                liste_type_donnees = liste_data_types,
                liste_lignes_titre = liste_lignes_titre,
                liste_lignes_section = liste_lignes_section,
                liste_lignes_sous_total = liste_lignes_sous_total,
                liste_lignes_precision_1 = liste_lignes_precision_1,
                liste_lignes_precision_2 = liste_lignes_precision_2,
                liste_lignes_precision_3 = liste_lignes_precision_3,
                liste_lignes_precision_4 = liste_lignes_precision_4,
                liste_lignes_total = liste_lignes_total,
                liste_lignes_italique = liste_lignes_italique,
                liste_unif_unites = liste_unif_unites,
                liste_cellules_fusion = liste_cells_to_merge,
                col_debut = col_debut,
                avec_titre = TRUE)
  tab <- 0
  for (feuille in names(wb)) {
    tab <- tab + 1
    max_ligne_titre <- max(liste_lignes_titre[[tab]])
    liste_unites <- unlist(strsplit(str_trim(plan$Liste_unites[tab]), split = ", "))
    if (length(liste_unites) > 1) {
      nb_col <- ncol(readWorkbook(wb,
                                  sheet = feuille))
      addStyle(wb = wb,
               sheet = feuille,
               style = styles$lignes_unites_differentes,
               rows = ligne_debut + max_ligne_titre,
               cols = col_debut:(nb_col + col_debut - 1))
    }
  }
  
  nom_feuille_sommaire <- "Sommaire"
  col_sommaire <- 1
  plan[,4:5][is.na(plan[,4:5])] <- ""
  addWorksheet(wb = wb, sheetName = nom_feuille_sommaire)
  
  setColWidths(wb = wb, sheet = nom_feuille_sommaire, cols = col_sommaire, widths = 83)
  writeData(wb = wb, sheet = nom_feuille_sommaire, x = "Sommaire")
  addStyle(wb = wb, sheet = nom_feuille_sommaire,
           style = styles$titre, rows = 1, cols = col_sommaire)
  index_chap <- 1
  for (chap in plan$Chapitre) {
    if (index_chap > 1) {
      if (chap %in% plan$Chapitre[1:(index_chap-1)]) {
        plan$Chapitre[index_chap] <- ""
      }
    }
    index_chap <- index_chap + 1
  }
  index_sous_chap <- 1
  for (sous_chap in plan$`Sous-chapitre`) {
    if (index_sous_chap > 1) {
      if (sous_chap %in% plan$`Sous-chapitre`[1:(index_sous_chap-1)]) {
        plan$`Sous-chapitre`[index_sous_chap] <- ""
      }
    }
    index_sous_chap <- index_sous_chap + 1
  }
  ligne_actuelle = 3
  titre_ecrit <- FALSE
  
  for (i in 1:nrow(plan)) {
    if (plan$Chapitre[i] != "") {
      writeData(wb = wb, sheet = nom_feuille_sommaire, x = plan$Chapitre[i],
                startCol = col_sommaire, startRow = ligne_actuelle)
      setRowHeights(wb = wb,
                sheet = nom_feuille_sommaire,
                rows = ligne_actuelle,
                heights = (1 + nchar(plan$Chapitre[i])%/%100)*15)
      addStyle(wb = wb, sheet = nom_feuille_sommaire,
               style = styles$sommaire_chapitre,
               rows = ligne_actuelle, cols = col_sommaire)
      titre_ecrit <- FALSE
      ligne_actuelle <- ligne_actuelle + 1
      if (plan$`Sous-chapitre`[i] != "") {
        writeData(wb = wb, sheet = nom_feuille_sommaire, x = plan$`Sous-chapitre`[i],
                startCol = col_sommaire, startRow = ligne_actuelle)
        setRowHeights(wb = wb,
                      sheet = nom_feuille_sommaire,
                      rows = ligne_actuelle,
                      heights = (1 + nchar(plan$`Sous-chapitre`[i])%/%100)*15)
        addStyle(wb = wb, sheet = nom_feuille_sommaire,
                 style = styles$sommaire_sous_chapitre,
                 rows = ligne_actuelle, cols = col_sommaire)
        titre_ecrit <- FALSE
        ligne_actuelle <- ligne_actuelle + 1
      }
    } else if (plan$`Sous-chapitre`[i] != "") {
      writeData(wb = wb, sheet = nom_feuille_sommaire, x = plan$`Sous-chapitre`[i],
                startCol = col_sommaire, startRow = ligne_actuelle)
      setRowHeights(wb = wb,
                sheet = nom_feuille_sommaire,
                rows = ligne_actuelle,
                heights = (1 + nchar(plan$`Sous-chapitre`[i])%/%100)*15)
      addStyle(wb = wb, sheet = nom_feuille_sommaire,
               style = styles$sommaire_sous_chapitre,
               rows = ligne_actuelle, cols = col_sommaire)
      titre_ecrit <- FALSE
      ligne_actuelle <- ligne_actuelle + 1
    } else {
      writeFormula(wb = wb, sheet = nom_feuille_sommaire,
                   x = makeHyperlinkString(sheet = plan$Nom_feuille[i],
                                           text = plan$Titre[i],
                                           row = 1,
                                           col = 1), 
                   startCol = col_sommaire,
                   startRow = ligne_actuelle)
      
      setRowHeights(wb = wb,
                sheet = nom_feuille_sommaire,
                rows = ligne_actuelle,
                heights = (1 + nchar(plan$Titre[i])%/%100)*15)
                
      addStyle(wb = wb, sheet = nom_feuille_sommaire,
               style = styles$sommaire_lien,
               rows = ligne_actuelle, cols = col_sommaire)
      titre_ecrit <- TRUE
      ligne_actuelle <- ligne_actuelle + 1
    }
    
    
    if (titre_ecrit == FALSE) {
      writeFormula(wb = wb, sheet = nom_feuille_sommaire,
                   x = makeHyperlinkString(sheet = plan$Nom_feuille[i],
                                           text = plan$Titre[i],
                                           row = 1,
                                           col = 1), 
                   startCol = col_sommaire,
                   startRow = ligne_actuelle)
      setRowHeights(wb = wb,
                sheet = nom_feuille_sommaire,
                rows = ligne_actuelle,
                heights = (1 + nchar(plan$Titre[i])%/%100)*15)
      addStyle(wb = wb, sheet = nom_feuille_sommaire,
               style = styles$sommaire_lien,
               rows = ligne_actuelle, cols = col_sommaire)
      titre_ecrit <- TRUE
      ligne_actuelle <- ligne_actuelle + 1
    }
  }
  
  for (nom_feuille in names(wb)) {
    if (nom_feuille != nom_feuille_sommaire) {
      cols <- ncol(readWorkbook(wb, sheet = nom_feuille)) + col_debut + 1
      writeFormula(wb = wb, sheet = nom_feuille,
                 x = makeHyperlinkString(sheet = nom_feuille_sommaire,
                                         text = "Retour sommaire",
                                         row = 1,
                                         col = 1),
                 startCol = cols,
                 startRow = 1)
      addStyle(wb = wb, sheet = nom_feuille,
               style = styles$bouton_retour_sommaire,
               rows = 1, cols = cols)
      mergeCells(wb = wb, sheet = nom_feuille, cols = cols:(cols+2), rows = 1:2)
    }
    
  }
  
  ord <- c(nb_tab + 1, 1:nb_tab)
  worksheetOrder(wb = wb) <- ord
  
  if (isTRUE(save)) {
    saveWorkbook(wb, file = path, overwrite = TRUE)
    browseURL(url = path)
  }
  
  return(wb)
}


```

```{r examples-creer_excel_depuis_plan, eval=FALSE}
library(agreste)
library(dplyr)
library(openxlsx)
library(rstudioapi)
### Import du fichier de plan
plan = agreste::modele_plan

### Création des csv 
agreste::resultat_1 %>%
  write.csv(file = "resultat_1.csv", row.names = FALSE)
agreste::resultat_2 %>%
  write.csv(file = "resultat_2.csv", row.names = FALSE)
agreste::resultat_3 %>%
  write.csv(file = "resultat_3.csv", row.names = FALSE)
agreste::lait_vache %>%
  write.csv(file = "lait_vache.csv", row.names = FALSE)
agreste::scieries2020 %>%
  write.csv(file = "scieries2020.csv", row.names = FALSE)
write.xlsx(plan, "plan.xlsx", row.names = FALSE)

### Formatage
workbook <- creer_excel_depuis_plan(plan = "plan.xlsx",
                                    datadir = choose.dir(),
                                    format = "chiffres_et_donnees",
                                    col_debut = 1,
                                    save = TRUE,
                                    path = "document_a_envoyer.xlsx",
                                    type_virgule = ",")

```

```{r tests-creer_excel_depuis_plan}
test_that("Le formatage se fait correctement et sans erreur", {
  
  plan <- agreste::modele_plan
  
  temp_dir <- tempdir()
  
  file1 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file2 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file3 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file4 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file5 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file_plan <- tempfile(pattern = "file", tmpdir = temp_dir, fileext = ".xlsx")
  
  agreste::resultat_1 %>%
    write.csv(file = paste(file1, "csv", sep = "."), row.names = FALSE)
  agreste::resultat_2 %>%
    write.csv(file = paste(file2, "csv", sep = "."), row.names = FALSE)
  agreste::resultat_3 %>%
    write.csv(file = paste(file3, "csv", sep = "."), row.names = FALSE)
  agreste::lait_vache %>%
    openxlsx::write.xlsx(file = paste(file4, "xlsx", sep = "."), rowNames = FALSE)
  agreste::scieries2020 %>%
    openxlsx::write.xlsx(file = paste(file5, "xlsx", sep = "."), rowNames = FALSE)
  
  plan$Nom_fichier[1] <- basename(file1)
  plan$Nom_fichier[2] <- basename(file2)
  plan$Nom_fichier[3] <- basename(file3)
  plan$Nom_fichier[4] <- basename(file4)
  plan$Nom_fichier[5] <- basename(file5)
  
  openxlsx::write.xlsx(plan, file_plan, rowNames = FALSE)
  
  expect_error(creer_excel_depuis_plan(plan = 1,
                                       datadir = temp_dir,
                                       format = "primeur",
                                       col_debut = 2,
                                       save = FALSE),
               "Le plan doit \u00eatre une cha\u00eene de caract\u00e8res ou un data frame.")
  expect_error(creer_excel_depuis_plan(plan = file_plan,
                                       datadir = temp_dir,
                                               format = "irapide",
                                               col_debut = 2,
                                               save = FALSE),
               'Le format doit \u00eatre "chiffres_et_donnees" ou "primeur".')
  expect_error(creer_excel_depuis_plan(plan = file_plan,
                                       datadir = temp_dir,
                                               format = "chiffres_et_donnees",
                                               col_debut = "B",
                                               save = FALSE),
               "La colonne de d\u00e9but doit \u00eatre NULL ou bien un entier positif.")
  expect_error(creer_excel_depuis_plan(plan = file_plan,
                                       datadir = temp_dir,
                                               format = "chiffres_et_donnees",
                                               col_debut = 2,
                                               save = "oui"),
               "save doit \u00eatre TRUE ou FALSE")
  expect_error(creer_excel_depuis_plan(plan = file_plan,
                                       datadir = temp_dir,
                                               format = "chiffres_et_donnees",
                                               col_debut = 2,
                                               save = TRUE,
                                               path = plan),
               "Le chemin du fichier \u00e0 sauvegarder doit \u00eatre une cha\u00eene de caract\u00e8res.")
  expect_error(creer_excel_depuis_plan(plan = file_plan,
                                       datadir = temp_dir,
                                               format = "chiffres_et_donnees",
                                               col_debut = 2,
                                               save = TRUE,
                                               path = file_plan,
                                               type_virgule = ";"),
               'Le type de virgule doit \u00eatre "." ou ","')
})

test_that("Le classeur est bien modifié pour un c&d", {
  plan <- agreste::modele_plan
  
  temp_dir <- tempdir()
  
  file1 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file2 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file3 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file4 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file5 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file_plan <- tempfile(pattern = "file", tmpdir = temp_dir, fileext = ".xlsx")
  
  agreste::resultat_1 %>%
    write.csv(file = paste(file1, "csv", sep = "."), row.names = FALSE)
  agreste::resultat_2 %>%
    write.csv(file = paste(file2, "csv", sep = "."), row.names = FALSE)
  agreste::resultat_3 %>%
    write.csv(file = paste(file3, "csv", sep = "."), row.names = FALSE)
  agreste::lait_vache %>%
    openxlsx::write.xlsx(file = paste(file4, "xlsx", sep = "."), rowNames = FALSE)
  agreste::scieries2020 %>%
    openxlsx::write.xlsx(file = paste(file5, "xlsx", sep = "."), rowNames = FALSE)
  
  plan$Nom_fichier[1] <- basename(file1)
  plan$Nom_fichier[2] <- basename(file2)
  plan$Nom_fichier[3] <- basename(file3)
  plan$Nom_fichier[4] <- basename(file4)
  plan$Nom_fichier[5] <- basename(file5)
  
  openxlsx::write.xlsx(plan, file_plan, rowNames = FALSE)
  
  workbook <- creer_excel_depuis_plan(plan = file_plan,
                                      datadir = temp_dir,
                                      format = "chiffres_et_donnees",
                                      col_debut = 1,
                                      save = FALSE,
                                      type_virgule = ".")
  expect_true(file.info(file_plan)$size > 0)
  expect_equal(length(names(workbook)),
               6)
  expect_equal(names(workbook),
               c(agreste::modele_plan$Nom_feuille, "Sommaire"))
  expect_equal(length(openxlsx::getStyles(workbook)),
               131)
  expect_equal(nrow(readWorkbook(workbook,
                                 skipEmptyRows = FALSE,
                                 colNames = FALSE,
                                 sheet = agreste::modele_plan$Nom_feuille[1])),
               23)
  expect_equal(nrow(readWorkbook(workbook,
                                 skipEmptyRows = FALSE,
                                 colNames = FALSE,
                                 sheet = agreste::modele_plan$Nom_feuille[2])),
               11)
  expect_equal(nrow(readWorkbook(workbook,
                                 skipEmptyRows = FALSE,
                                 colNames = FALSE,
                                 sheet = agreste::modele_plan$Nom_feuille[3])),
               17)
})

test_that("Le classeur est bien modifié pour un primeur", {
  plan <- agreste::modele_plan
  
  temp_dir <- tempdir()
  
  file1 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file2 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file3 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file4 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file5 <- tempfile(pattern = "file", tmpdir = temp_dir)
  file_plan <- tempfile(pattern = "file", tmpdir = temp_dir, fileext = ".xlsx")
  
  agreste::resultat_1 %>%
    write.csv(file = paste(file1, "csv", sep = "."), row.names = FALSE)
  agreste::resultat_2 %>%
    write.csv(file = paste(file2, "csv", sep = "."), row.names = FALSE)
  agreste::resultat_3 %>%
    write.csv(file = paste(file3, "csv", sep = "."), row.names = FALSE)
  agreste::lait_vache %>%
    openxlsx::write.xlsx(file = paste(file4, "xlsx", sep = "."), rowNames = FALSE)
  agreste::scieries2020 %>%
    openxlsx::write.xlsx(file = paste(file5, "xlsx", sep = "."), rowNames = FALSE)
  
  plan$Nom_fichier[1] <- basename(file1)
  plan$Nom_fichier[2] <- basename(file2)
  plan$Nom_fichier[3] <- basename(file3)
  plan$Nom_fichier[4] <- basename(file4)
  plan$Nom_fichier[5] <- basename(file5)
  
  openxlsx::write.xlsx(plan, file_plan, rowNames = FALSE)
  
  workbook <- creer_excel_depuis_plan(plan = file_plan,
                                      datadir = temp_dir,
                                      format = "primeur",
                                      col_debut = 2,
                                      save = FALSE,
                                      path = file_plan,
                                      type_virgule = ".")

  expect_equal(length(names(workbook)),
               6)
  expect_equal(names(workbook),
               c(agreste::modele_plan$Nom_feuille, "Sommaire"))
  expect_equal(length(openxlsx::getStyles(workbook)),
               136)
  expect_equal(nrow(readWorkbook(workbook,
                                 skipEmptyRows = FALSE,
                                 colNames = FALSE,
                                 sheet = agreste::modele_plan$Nom_feuille[1])),
               24)
  expect_equal(nrow(readWorkbook(workbook,
                                 skipEmptyRows = FALSE,
                                 colNames = FALSE,
                                 sheet = agreste::modele_plan$Nom_feuille[2])),
               12)
  expect_equal(nrow(readWorkbook(workbook,
                                 skipEmptyRows = FALSE,
                                 colNames = FALSE,
                                 sheet = agreste::modele_plan$Nom_feuille[3])),
               18)
})

```

# Lire un fichier de n'importe quel type (courant)

Permet de lire un fichier de type csv, tsv, xlsx, ods, rds, parquet, feather

```{r function-read_any_file} 
#' Lit un fichier
#' 
#' Prend en charge les fichiers csv, xlsx, rds
#' 
#' @param filename CHAR le nom du fichier, extension incluse
#' 
#' @importFrom reader get.ext
#' @importFrom openxlsx read.xlsx
#' @importFrom arrow read_parquet
#' @importFrom readODS read_ods
#'
#' @export
#' 
#' @examples
#' 
#' @return A dataframe
read_any_file <- function(filename,
                          header = TRUE,
                          sep = ",",
                          decimal_mark = ".",
                          sheet = 1) {
  if (isFALSE(file.exists(filename))) {
    stop(paste("Le fichier", filename, "n'existe pas."))
  }
  extension <- get.ext(filename)
  data = switch (extension,
    "csv" = read.csv(file = filename,
                     header = TRUE,
                     sep = sep,
                     dec = decimal_mark,
                     check.names = FALSE,
                     strip.white = TRUE),
    "tsv" = read.csv(file = filename,
                     header = TRUE,
                     sep = sep,
                     dec = decimal_mark,
                     check.names = FALSE,
                     strip.white = TRUE),
    "xlsx" = read.xlsx(xlsxFile = filename,
                       sheet = sheet, 
                       check.names = FALSE,
                       colNames = header,
                       sep.names = " ",
                       skipEmptyRows = FALSE,
                       skipEmptyCols = FALSE),
    "rds" = as.data.frame(readRDS(file = filename)),
    "Rds" = as.data.frame(readRDS(file = filename)),
    "RDS" = as.data.frame(readRDS(file = filename)),
    "parquet" = read_parquet(file = filename,
                             as_data_frame = TRUE),
    "feather" = as.data.frame(read_feather(path = filename)),
    "dataframe" = eval(parse(text = unlist(strsplit(filename, "\\."))[1])),
    "ods" = read_ods(path = filename, sheet = 1, col_names = header,
                     formula_as_formula = FALSE, row_names = FALSE)
  )
  return(data)
  
}
```

```{r examples-read_any_file, eval=FALSE}
#' \dontrun{
library(agreste)
write.csv(iris, "iris.csv", row.names = FALSE, sep = ",")
df <- read_any_file(filename = "iris.csv", header = TRUE, sep = ",", decimal_mark = ".")
#'}
```

```{r development-inflate, eval=FALSE}
fusen::inflate(flat_file = "dev/flat_export_excel.Rmd", vignette_name = "Export excel", check=F, overwrite = "yes")
```
